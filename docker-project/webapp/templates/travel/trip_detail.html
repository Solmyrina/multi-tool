{% extends "base.html" %}

{% block title %}{{ trip.name }} - Travel Planner{% endblock %}

{% block extra_head %}
<!-- Leaflet.js for Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- External CSS files -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/trip_detail.css') }}?v={{ range(1, 10000) | random }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar.css') }}?v={{ range(1, 10000) | random }}">

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<!-- Note: All custom styles moved to trip_detail.css and calendar.css -->
{% endblock %}

{% block content %}
<div class="container-fluid mt-2 px-3">
    <!-- Trip Header -->
    <div class="sticky-header border-bottom pb-2 mb-2 bg-white">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a href="{{ url_for('travel_list') }}">My Trips</a></li>
                        <li class="breadcrumb-item active">{{ trip.name }}</li>
                    </ol>
                </nav>
                
                <div class="d-flex flex-wrap gap-3">
                    <div>
                        <i class="fas fa-map-marker-alt text-primary"></i>
                        <span class="ms-1">{{ trip.destination_city }}{% if trip.destination_country %}, {{ trip.destination_country }}{% endif %}</span>
                    </div>
                    <div>
                        <i class="fas fa-calendar text-primary"></i>
                        <span class="ms-1">{{ trip.start_date|format_date }} - {{ trip.end_date|format_date }}</span>
                    </div>
                    <div>
                        <i class="fas fa-clock text-primary"></i>
                        <span class="ms-1">{{ trip.duration_days }} days</span>
                    </div>
                    <div>
                        <i class="fas fa-map-marked-alt text-success"></i>
                        <span class="ms-1">{{ trip.activity_count }} activities</span>
                    </div>
                    <div>
                        <i class="fas fa-hotel text-info"></i>
                        <span class="ms-1">{{ trip.accommodation_count }} accommodations</span>
                    </div>
                    <div>
                        <i class="fas fa-route text-warning"></i>
                        <span class="ms-1">{{ trip.route_count }} routes</span>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4 text-end">
                <div class="d-flex flex-wrap gap-2 justify-content-end">
                    <button class="btn btn-primary btn-sm" onclick="openShareModal()">
                        <i class="fas fa-share-alt"></i> Share Trip
                    </button>
                    <a href="{{ url_for('export_calendar', trip_id=trip.id) }}" 
                       class="btn btn-success btn-sm"
                       download="{{ trip.name }}.ics">
                        <i class="fas fa-calendar-plus"></i> Add to Calendar
                    </a>
                    <button class="btn btn-outline-primary btn-sm" onclick="showDailyView()">
                        <i class="fas fa-calendar-day"></i> Daily View
                    </button>
                    <a href="{{ url_for('trip_edit', trip_id=trip.id) }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-edit"></i> Edit Trip
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs" id="tripTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button">
                <i class="fas fa-th-large"></i> Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" type="button">
                <i class="fas fa-chart-gantt"></i> Timeline
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="activities-tab" data-bs-toggle="tab" data-bs-target="#activities" type="button">
                <i class="fas fa-map-marked-alt"></i> Activities <span class="badge bg-secondary">{{ trip.activity_count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="accommodations-tab" data-bs-toggle="tab" data-bs-target="#accommodations" type="button">
                <i class="fas fa-hotel"></i> Accommodations <span class="badge bg-secondary">{{ trip.accommodation_count }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <!-- Budget tab is hidden by default to prevent flash of content before permissions are applied -->
            <button class="nav-link" id="budget-tab" data-bs-toggle="tab" data-bs-target="#budget" type="button" style="display:none" data-perm="budget">
                <i class="fas fa-wallet"></i> Budget
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="packing-tab" data-bs-toggle="tab" data-bs-target="#packing" type="button">
                <i class="fas fa-suitcase"></i> Packing List
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button">
                <i class="fas fa-calendar-alt"></i> Calendar
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="tripTabsContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row g-2">
                <!-- Map -->
                <div class="col-lg-9">
                    <div class="card">
                        <div class="card-body p-0">
                            <div id="tripMap" style="background: #f0f0f0; position: relative;">
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <i class="fas fa-map fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">Map will load here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="col-lg-3">
                    <!-- Weather Widget -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-cloud-sun"></i> Weather Forecast</h6>
                        </div>
                        <div class="card-body">
                            <div id="weatherWidget" class="text-center">
                                <p class="text-muted small mb-0">Weather data not available</p>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-bolt"></i> Quick Actions</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm" onclick="addActivity()">
                                    <i class="fas fa-plus"></i> Add Activity
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="addAccommodation()">
                                    <i class="fas fa-plus"></i> Add Accommodation
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="addExpense()">
                                    <i class="fas fa-plus"></i> Add Expense
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Budget Summary -->
                    {% if trip.budget_total %}
                    <div class="card budget-field">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-dollar-sign"></i> Budget Overview</h6>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Spent</span>
                                <strong>{{ trip.total_spent|default(0) }} {{ trip.budget_currency }}</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Budget</span>
                                <strong>{{ trip.budget_total }} {{ trip.budget_currency }}</strong>
                            </div>
                            
                            {% set budget_percent = ((trip.total_spent|default(0) / trip.budget_total) * 100)|int %}
                            <div class="progress mb-2" style="height: 20px;">
                                <div class="progress-bar bg-{{ 'danger' if budget_percent > 100 else 'warning' if budget_percent > 80 else 'success' }}" 
                                     role="progressbar" 
                                     style="width: {{ [budget_percent, 100]|min }}%">
                                    {{ budget_percent }}%
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <span class="text-muted">Remaining</span>
                                <strong class="text-{{ 'danger' if budget_percent > 100 else 'success' }}">
                                    {{ trip.budget_total - trip.total_spent|default(0) }} {{ trip.budget_currency }}
                                </strong>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Timeline Tab (Gantt Chart) -->
        <div class="tab-pane fade" id="timeline" role="tabpanel">
            <h5 class="mb-3"><i class="fas fa-chart-gantt"></i> Trip Timeline</h5>
            <div id="ganttChart" style="min-height: 500px;">
                <!-- Gantt chart will be rendered here -->
            </div>
        </div>

        <!-- Activities Tab -->
        <div class="tab-pane fade" id="activities" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Activities</h4>
                <button class="btn btn-primary" onclick="addActivity()">
                    <i class="fas fa-plus"></i> Add Activity
                </button>
            </div>

            <div id="activitiesList">
                <!-- Activities will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading activities...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Accommodations Tab -->
        <div class="tab-pane fade" id="accommodations" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Accommodations</h4>
                <button class="btn btn-success" onclick="addAccommodation()">
                    <i class="fas fa-plus"></i> Add Accommodation
                </button>
            </div>

            <div id="accommodationsList">
                <!-- Accommodations will be loaded here -->
                <div class="text-center py-5">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading accommodations...</span>
                    </div>
                </div>
            </div>
        </div>

    <!-- Budget Tab (hidden by default; shown by JS when permitted) -->
    <div class="tab-pane fade" id="budget" role="tabpanel" style="display:none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Budget & Expenses</h4>
                <button class="btn btn-warning" onclick="addExpense()">
                    <i class="fas fa-plus"></i> Add Expense
                </button>
            </div>

            <!-- Budget Summary Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Total Budget</h6>
                            <h3 id="budgetTotal">-</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Planned Costs</h6>
                            <h4 class="text-primary" id="plannedCosts">-</h4>
                            <small class="text-muted">Activities + Accommodations</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Other Expenses</h6>
                            <h4 class="text-warning" id="otherExpenses">-</h4>
                            <small class="text-muted">Manual expenses</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Remaining</h6>
                            <h3 class="text-success" id="budgetRemaining">-</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Budget Breakdown -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-chart-pie"></i> Planned Costs Breakdown</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span><i class="fas fa-hotel text-success"></i> Accommodations</span>
                                    <strong id="accommodationCosts">-</strong>
                                </div>
                                <div class="progress mt-1" style="height: 8px;">
                                    <div id="accommodationProgress" class="progress-bar bg-success" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span><i class="fas fa-calendar-alt text-primary"></i> Activities</span>
                                    <strong id="activityCosts">-</strong>
                                </div>
                                <div class="progress mt-1" style="height: 8px;">
                                    <div id="activityProgress" class="progress-bar bg-primary" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-wallet"></i> Expense Categories</h6>
                        </div>
                        <div class="card-body" id="expenseCategorySummary">
                            <p class="text-muted text-center">No expenses yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Expenses List -->
            <div id="expensesList">
                <div class="text-center py-5">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading expenses...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Packing List Tab -->
        <div class="tab-pane fade" id="packing" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Packing List</h4>
                <button class="btn btn-primary" onclick="addPackingItem()">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>

            <!-- Packing Progress -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Packing Progress</h6>
                        <span id="packingProgress">0 / 0 items packed</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div id="packingProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%">
                            <span id="packingProgressText">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Packing List by Category -->
            <div id="packingList">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading packing list...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div class="tab-pane fade" id="calendar" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Trip Calendar</h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="calendarPrevWeek()">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="calendarToday()">
                        <i class="fas fa-calendar-day"></i> Today
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="calendarTomorrow()">
                        <i class="fas fa-calendar-plus"></i> Tomorrow
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="calendarNextWeek()">
                        Next <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Week Overview -->
            <div class="card mb-3">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="calendarWeekRange">Loading...</h5>
                        <small class="text-muted" id="calendarTripInfo"></small>
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div id='calendar'></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalLabel">Add Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="activityForm">
                    <input type="hidden" id="activityId" name="id">
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="activityName" class="form-label">Activity Name *</label>
                            <input type="text" class="form-control" id="activityName" name="name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="activityCategory" class="form-label">Category *</label>
                            <select class="form-select" id="activityCategory" name="category" required>
                                <option value="sightseeing">Sightseeing</option>
                                <option value="dining">Dining</option>
                                <option value="transport">Transport</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="shopping">Shopping</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="activityDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="activityDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="activityStartDate" class="form-label">Start Date *</label>
                            <input type="date" class="form-control" id="activityStartDate" name="start_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activityStartTime" class="form-label">Start Time</label>
                            <input type="time" class="form-control" id="activityStartTime" name="start_time">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="activityEndDate" class="form-label">End Date *</label>
                            <input type="date" class="form-control" id="activityEndDate" name="end_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activityEndTime" class="form-label">End Time</label>
                            <input type="time" class="form-control" id="activityEndTime" name="end_time">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="activityLocation" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="activityLocation" name="location_name" placeholder="Address or place name">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="activityCity" class="form-label">City <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="text" class="form-control" id="activityCity" name="city" placeholder="e.g., Paris">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="activityCountry" class="form-label">Country <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="text" class="form-control" id="activityCountry" name="country" placeholder="e.g., France">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="activityAddress" class="form-label">Address</label>
                            <input type="text" class="form-control" id="activityAddress" name="address" placeholder="Street address">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="activityLatitude" class="form-label">Latitude <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="number" step="any" min="-90" max="90" class="form-control" id="activityLatitude" name="latitude" placeholder="48.8566">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="activityLongitude" class="form-label">Longitude <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="number" step="any" min="-180" max="180" class="form-control" id="activityLongitude" name="longitude" placeholder="2.3522">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="activityPriority" class="form-label">Priority</label>
                            <select class="form-select" id="activityPriority" name="priority">
                                <option value="optional">Optional</option>
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="must_see">Must See</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 budget-field">
                            <label for="activityCost" class="form-label">Estimated Cost</label>
                            <input type="number" step="0.01" class="form-control" id="activityCost" name="cost" placeholder="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="activityDuration" class="form-label">Duration (hours)</label>
                            <input type="number" step="0.5" class="form-control" id="activityDuration" name="duration_minutes" placeholder="2.0">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="activityNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="activityNotes" name="notes" rows="2" placeholder="Booking info, tips, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteActivityBtn" onclick="deleteActivityConfirm()" style="display: none;">Delete</button>
                <button type="button" class="btn btn-primary" onclick="saveActivity()">Save Activity</button>
            </div>
        </div>
    </div>
</div>

<!-- Accommodation Modal -->
<div class="modal fade" id="accommodationModal" tabindex="-1" aria-labelledby="accommodationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="accommodationModalLabel">Add Accommodation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="accommodationForm">
                    <input type="hidden" id="accommodationId" name="id">
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="accommodationName" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="accommodationName" name="name" required placeholder="Hotel, Airbnb, etc.">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="accommodationType" class="form-label">Type *</label>
                            <select class="form-select" id="accommodationType" name="accommodation_type" required>
                                <option value="hotel">Hotel</option>
                                <option value="hostel">Hostel</option>
                                <option value="airbnb">Airbnb</option>
                                <option value="resort">Resort</option>
                                <option value="guesthouse">Guesthouse</option>
                                <option value="apartment">Apartment</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="accommodationAddress" class="form-label">Address</label>
                            <input type="text" class="form-control" id="accommodationAddress" name="address">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="accommodationCity" class="form-label">City <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="text" class="form-control" id="accommodationCity" name="city">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="accommodationCountry" class="form-label">Country <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="text" class="form-control" id="accommodationCountry" name="country">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="accommodationLatitude" class="form-label">Latitude <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="number" step="any" min="-90" max="90" class="form-control" id="accommodationLatitude" name="latitude">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="accommodationLongitude" class="form-label">Longitude <i class="fas fa-cloud text-info" title="Will be added to weather tracking"></i></label>
                            <input type="number" step="any" min="-180" max="180" class="form-control" id="accommodationLongitude" name="longitude">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="accommodationPhone" class="form-label">Phone</label>
                            <input type="tel" class="form-control" id="accommodationPhone" name="phone">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="accommodationWebsite" class="form-label">Website</label>
                            <input type="url" class="form-control" id="accommodationWebsite" name="website">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="accommodationCheckIn" class="form-label">Check-in Date *</label>
                            <input type="date" class="form-control" id="accommodationCheckIn" name="check_in_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="accommodationCheckInTime" class="form-label">Check-in Time</label>
                            <input type="time" class="form-control" id="accommodationCheckInTime" name="check_in_time" value="15:00">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="accommodationCheckOut" class="form-label">Check-out Date *</label>
                            <input type="date" class="form-control" id="accommodationCheckOut" name="check_out_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="accommodationCheckOutTime" class="form-label">Check-out Time</label>
                            <input type="time" class="form-control" id="accommodationCheckOutTime" name="check_out_time" value="11:00">
                        </div>
                    </div>

                    <div class="row budget-field">
                        <div class="col-md-6 mb-3">
                            <label for="accommodationCost" class="form-label">Total Cost</label>
                            <input type="number" step="0.01" class="form-control" id="accommodationCost" name="total_cost" placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="accommodationCurrency" class="form-label">Currency</label>
                            <select class="form-select" id="accommodationCurrency" name="currency">
                                <option value="EUR">EUR (€)</option>
                                <option value="USD" selected>USD ($)</option>
                                <option value="GBP">GBP (£)</option>
                                <option value="JPY">JPY (¥)</option>
                                <option value="AUD">AUD (A$)</option>
                                <option value="CAD">CAD (C$)</option>
                                <option value="CHF">CHF (Fr)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="accommodationConfirmation" class="form-label">Confirmation Number</label>
                            <input type="text" class="form-control" id="accommodationConfirmation" name="confirmation_number">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="accommodationStatus" class="form-label">Status</label>
                            <select class="form-select" id="accommodationStatus" name="booking_status">
                                <option value="planned">Planned</option>
                                <option value="reserved">Reserved</option>
                                <option value="confirmed" selected>Confirmed</option>
                                <option value="checked_in">Checked In</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="accommodationNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="accommodationNotes" name="notes" rows="3" placeholder="Amenities, parking, etc."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteAccommodationBtn" onclick="deleteAccommodationConfirm()" style="display: none;">Delete</button>
                <button type="button" class="btn btn-success" onclick="saveAccommodation()">Save Accommodation</button>
            </div>
        </div>
    </div>
</div>

<!-- Expense Modal -->
<div class="modal fade" id="expenseModal" tabindex="-1" aria-labelledby="expenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="expenseModalLabel">Add Expense</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="expenseForm">
                    <input type="hidden" id="expenseId" name="id">
                    
                    <div class="mb-3">
                        <label for="expenseDescription" class="form-label">Description *</label>
                        <input type="text" class="form-control" id="expenseDescription" name="description" required placeholder="e.g., Taxi to airport">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expenseAmount" class="form-label">Amount *</label>
                            <input type="number" step="0.01" class="form-control" id="expenseAmount" name="amount" required placeholder="0.00">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="expenseCurrency" class="form-label">Currency *</label>
                            <input type="text" class="form-control" id="expenseCurrency" name="currency" value="{{ trip.budget_currency }}" required maxlength="3" placeholder="EUR">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expenseDate" class="form-label">Date *</label>
                            <input type="date" class="form-control" id="expenseDate" name="expense_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="expenseCategory" class="form-label">Category</label>
                            <select class="form-select" id="expenseCategory" name="category">
                                <option value="">Select category</option>
                                <option value="accommodation">Accommodation</option>
                                <option value="transport">Transport</option>
                                <option value="food">Food & Dining</option>
                                <option value="activities">Activities</option>
                                <option value="shopping">Shopping</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="expenseNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="expenseNotes" name="notes" rows="2" placeholder="Additional details"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="deleteExpenseBtn" onclick="confirmDeleteExpense()" style="display: none;">Delete</button>
                <button type="button" class="btn btn-warning" onclick="saveExpense()">Save Expense</button>
            </div>
        </div>
    </div>
</div>

<!-- Packing Item Modal -->
<div class="modal fade" id="packingModal" tabindex="-1" aria-labelledby="packingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="packingModalLabel">Add Packing Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="packingForm">
                    <input type="hidden" id="packingItemId" name="id">
                    
                    <div class="mb-3">
                        <label for="packingItemName" class="form-label">Item Name *</label>
                        <input type="text" class="form-control" id="packingItemName" name="item_name" required placeholder="e.g., Passport, Sunscreen">
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="packingCategory" class="form-label">Category *</label>
                            <select class="form-select" id="packingCategory" name="category" required>
                                <option value="">Select category</option>
                                <option value="documents">Documents</option>
                                <option value="clothing">Clothing</option>
                                <option value="toiletries">Toiletries</option>
                                <option value="electronics">Electronics</option>
                                <option value="medication">Medication</option>
                                <option value="general">General</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="packingQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="packingQuantity" name="quantity" value="1" min="1">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="packingNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="packingNotes" name="notes" rows="2" placeholder="Size, color, or other details"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePackingItem()">Save Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Share Trip Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-share-alt"></i> Share Trip</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Add User Section -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user-plus"></i> Add User</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-8">
                                <input type="text" class="form-control" id="userSearchInput" 
                                       placeholder="Search by email or username..." autocomplete="off">
                                <div id="userSearchResults" class="list-group mt-2" style="display: none;"></div>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="defaultRole">
                                    <option value="viewer">Viewer (Read Only)</option>
                                    <option value="editor" selected>Editor</option>
                                    <option value="admin">Admin (Full Access)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Shares -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-users"></i> Shared With</h6>
                    </div>
                    <div class="card-body">
                        <div id="sharesList">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Permission Editor Modal -->
<div class="modal fade" id="permissionModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="fas fa-key"></i> Edit Permissions</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editShareId">
                <p class="mb-3">
                    <strong>User:</strong> <span id="editUserEmail"></span>
                </p>
                
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th class="text-center">
                                    <i class="fas fa-eye"></i> Read
                                </th>
                                <th class="text-center">
                                    <i class="fas fa-edit"></i> Write
                                </th>
                                <th class="text-center">
                                    <i class="fas fa-trash"></i> Delete
                                </th>
                            </tr>
                        </thead>
                        <tbody id="permissionsTable">
                            <!-- Budget -->
                            <tr>
                                <td><i class="fas fa-wallet text-warning"></i> Budget</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="budget" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="budget" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="budget" data-type="delete">
                                </td>
                            </tr>
                            <!-- Accommodations -->
                            <tr>
                                <td><i class="fas fa-hotel text-info"></i> Accommodations</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="accommodations" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="accommodations" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="accommodations" data-type="delete">
                                </td>
                            </tr>
                            <!-- Activities -->
                            <tr>
                                <td><i class="fas fa-map-marked-alt text-success"></i> Activities</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="activities" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="activities" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="activities" data-type="delete">
                                </td>
                            </tr>
                            <!-- Packing List -->
                            <tr>
                                <td><i class="fas fa-suitcase text-primary"></i> Packing List</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="packing_list" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="packing_list" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="packing_list" data-type="delete">
                                </td>
                            </tr>
                            <!-- Timeline -->
                            <tr>
                                <td><i class="fas fa-chart-gantt text-secondary"></i> Timeline</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="timeline" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="timeline" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="timeline" data-type="delete">
                                </td>
                            </tr>
                            <!-- Routes -->
                            <tr>
                                <td><i class="fas fa-route text-danger"></i> Routes</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="routes" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="routes" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="routes" data-type="delete">
                                </td>
                            </tr>
                            <!-- Documents -->
                            <tr>
                                <td><i class="fas fa-file text-muted"></i> Documents</td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="documents" data-type="read">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="documents" data-type="write">
                                </td>
                                <td class="text-center">
                                    <input type="checkbox" class="form-check-input" data-category="documents" data-type="delete">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> If budget access is disabled (no Read permission), 
                    the user will not see any cost information anywhere in the trip.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="savePermissions()">
                    <i class="fas fa-save"></i> Save Permissions
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<!-- All styles moved to external CSS files: trip_detail.css and calendar.css -->
{% endblock %}

{% block extra_scripts %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
const tripId = {{ trip.id }};
const tripCity = "{{ trip.destination_city or '' }}";
const tripCountry = "{{ trip.destination_country or '' }}";
const tripStartDate = "{{ trip.start_date }}";
const tripEndDate = "{{ trip.end_date }}";
</script>

<!-- External JavaScript Modules (load in order) -->
<script src="{{ url_for('static', filename='js/trip/utils.js') }}?v={{ range(1, 10000) | random }}"></script>
<script src="{{ url_for('static', filename='js/trip/calendar.js') }}?v={{ range(1, 10000) | random }}"></script>
<script src="{{ url_for('static', filename='js/trip/main.js') }}?v={{ range(1, 10000) | random }}"></script>
<script src="{{ url_for('static', filename='js/trip/init.js') }}?v={{ range(1, 10000) | random }}"></script>

<!-- Remaining inline functionality -->
<script>
// Note: userPermissions and isOwner are declared in main.js

// Initialize FullCalendar
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridWeek,timeGridDay'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        height: 'auto',
        expandRows: true,
        events: async function(info, successCallback, failureCallback) {
            try {
                const [activitiesRes, accommodationsRes] = await Promise.all([
                    fetch(`/api/travel/trips/${tripId}/activities`, { credentials: 'include' }),
                    fetch(`/api/travel/trips/${tripId}/accommodations`, { credentials: 'include' })
                ]);
                
                const activitiesData = await activitiesRes.json();
                const accommodationsData = await accommodationsRes.json();
                
                const events = [];
                
                // Add activities
                if (activitiesData.success && activitiesData.activities) {
                    activitiesData.activities.forEach(activity => {
                        const start = activity.start_datetime || `${activity.start_date}T${activity.start_time || '09:00'}`;
                        const end = activity.end_datetime || `${activity.end_date}T${activity.end_time || '10:00'}`;
                        
                        const categoryColors = {
                            'sightseeing': '#1976d2',
                            'dining': '#f57c00',
                            'transport': '#7b1fa2',
                            'entertainment': '#c2185b',
                            'shopping': '#388e3c',
                            'other': '#616161'
                        };
                        
                        events.push({
                            id: `activity-${activity.id}`,
                            title: activity.name,
                            start: start,
                            end: end,
                            backgroundColor: categoryColors[activity.category] || '#616161',
                            borderColor: categoryColors[activity.category] || '#616161',
                            extendedProps: {
                                type: 'activity',
                                activityId: activity.id,
                                location: activity.location_name
                            }
                        });
                    });
                }
                
                // Add accommodations
                if (accommodationsData.success && accommodationsData.accommodations) {
                    accommodationsData.accommodations.forEach(accommodation => {
                        const checkIn = `${accommodation.check_in_date}T${accommodation.check_in_time || '15:00'}`;
                        const checkOut = `${accommodation.check_out_date}T${accommodation.check_out_time || '11:00'}`;
                        
                        events.push({
                            id: `accommodation-${accommodation.id}`,
                            title: accommodation.name,
                            start: checkIn,
                            end: checkOut,
                            backgroundColor: '#f57f17',
                            borderColor: '#f57f17',
                            extendedProps: {
                                type: 'accommodation',
                                accommodationId: accommodation.id,
                                location: accommodation.address || accommodation.city
                            }
                        });
                    });
                }
                
                successCallback(events);
            } catch (error) {
                console.error('Error loading calendar events:', error);
                failureCallback(error);
            }
        },
        eventClick: function(info) {
            const props = info.event.extendedProps;
            if (props.type === 'activity') {
                editActivity(props.activityId);
            } else {
                editAccommodation(props.accommodationId);
            }
        },
        editable: true,
        eventDrop: function(info) {
            updateFullCalendarEventTime(info.event);
        },
        eventResize: function(info) {
            updateFullCalendarEventTime(info.event);
        }
    });
    
    calendar.render();
    
    // Store calendar reference globally
    window.tripCalendar = calendar;
});

// FullCalendar event update handler (separate from Calendar.updateEventTime for custom week view)
async function updateFullCalendarEventTime(event) {
    const props = event.extendedProps;
    const eventType = props.type;
    const eventId = eventType === 'activity' ? props.activityId : props.accommodationId;
    
    try {
        const endpoint = eventType === 'activity' 
            ? `/api/travel/trips/${tripId}/activities/${eventId}`
            : `/api/travel/trips/${tripId}/accommodations/${eventId}`;
        
        const updateData = {};
        const startDate = event.start.toISOString().split('T')[0];
        const startTime = event.start.toTimeString().substring(0, 5);
        const endDate = event.end.toISOString().split('T')[0];
        const endTime = event.end.toTimeString().substring(0, 5);
        
        if (eventType === 'activity') {
            updateData.start_date = startDate;
            updateData.start_time = startTime;
            updateData.end_date = endDate;
            updateData.end_time = endTime;
        } else {
            updateData.check_in_date = startDate;
            updateData.check_in_time = startTime;
            updateData.check_out_date = endDate;
            updateData.check_out_time = endTime;
        }
        
        const response = await fetch(endpoint, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(updateData)
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Event updated successfully', 'success');
            window.tripCalendar.refetchEvents();
        } else {
            showToast(data.error || 'Failed to update event', 'error');
            event.revert();
        }
    } catch (error) {
        console.error('Error updating event:', error);
        showToast('Failed to update event', 'error');
        event.revert();
    }
}

// Load weather widget and permissions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTripPermissions();
    loadWeatherWidget();
});

// Note: loadTripPermissions, hasPermission, applyPermissionControls, and hideBudgetFields
// are now in main.js and will be called from there

// Load weather widget and permissions on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTripPermissions();
    loadWeatherWidget();
});

// Load weather widget
async function loadWeatherWidget() {
    const weatherWidget = document.getElementById('weatherWidget');
    
    if (!tripCity || !tripCountry) {
        weatherWidget.innerHTML = `
            <p class="text-muted"><i class="fas fa-info-circle"></i> No destination set</p>
        `;
        return;
    }
    
    try {
        // First, search for city to get coordinates
        const searchResponse = await fetch(`/weather/api/search-cities?q=${encodeURIComponent(tripCity + ', ' + tripCountry)}`);
        const searchData = await searchResponse.json();
        
        if (searchData.success && searchData.cities && searchData.cities.length > 0) {
            const cityInfo = searchData.cities[0];
            
            // Now fetch actual weather data using coordinates
            const weatherResponse = await fetch(`/weather/api/forecast-by-coords?lat=${cityInfo.latitude}&lon=${cityInfo.longitude}`);
            const weatherData = await weatherResponse.json();
            
            if (weatherData.success) {
                displayWeather(weatherData.weather, cityInfo);
            } else {
                weatherWidget.innerHTML = `
                    <p class="text-muted"><i class="fas fa-cloud"></i> Weather data not available</p>
                `;
            }
        } else {
            weatherWidget.innerHTML = `
                <p class="text-muted"><i class="fas fa-cloud"></i> City not found</p>
            `;
        }
    } catch (error) {
        console.error('Error loading weather:', error);
        weatherWidget.innerHTML = `
            <p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Failed to load weather</p>
        `;
    }
}

function displayWeather(weatherData, cityInfo) {
    const weatherWidget = document.getElementById('weatherWidget');
    
    // Calculate days until trip
    const today = new Date();
    const startDate = new Date(tripStartDate);
    const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
    
    // Extract weather data from yr.no API response
    const temp = weatherData.temperature !== undefined ? Math.round(weatherData.temperature) : '--';
    const humidity = weatherData.humidity !== undefined ? Math.round(weatherData.humidity) : '--';
    const windSpeed = weatherData.wind_speed !== undefined ? weatherData.wind_speed.toFixed(1) : '--';
    const symbol = weatherData.symbol || 'unknown';
    
    // Map yr.no weather symbols to descriptive text
    let description = 'N/A';
    let weatherIcon = 'fa-cloud';
    
    if (symbol.includes('clearsky')) {
        description = 'Clear sky';
        weatherIcon = 'fa-sun';
    } else if (symbol.includes('fair')) {
        description = 'Fair';
        weatherIcon = 'fa-cloud-sun';
    } else if (symbol.includes('partlycloudy')) {
        description = 'Partly cloudy';
        weatherIcon = 'fa-cloud-sun';
    } else if (symbol.includes('cloudy')) {
        description = 'Cloudy';
        weatherIcon = 'fa-cloud';
    } else if (symbol.includes('rain') && symbol.includes('thunder')) {
        description = 'Thunderstorm';
        weatherIcon = 'fa-cloud-bolt';
    } else if (symbol.includes('rain')) {
        description = 'Rain';
        weatherIcon = 'fa-cloud-rain';
    } else if (symbol.includes('sleet')) {
        description = 'Sleet';
        weatherIcon = 'fa-cloud-meatball';
    } else if (symbol.includes('snow')) {
        description = 'Snow';
        weatherIcon = 'fa-snowflake';
    } else if (symbol.includes('fog')) {
        description = 'Fog';
        weatherIcon = 'fa-smog';
    }
    
    weatherWidget.innerHTML = `
        <div class="text-center mb-3">
            <i class="fas ${weatherIcon} fa-3x text-primary mb-2"></i>
            <h3 class="mb-0">${temp}°C</h3>
            <p class="text-muted mb-0">${description}</p>
            <small class="text-muted">${cityInfo.name}, ${cityInfo.country}</small>
        </div>
        <div class="row text-center">
            <div class="col-6">
                <small class="text-muted">Humidity</small>
                <p class="mb-0"><strong>${humidity}%</strong></p>
            </div>
            <div class="col-6">
                <small class="text-muted">Wind</small>
                <p class="mb-0"><strong>${windSpeed} m/s</strong></p>
            </div>
        </div>
        ${daysUntil > 0 ? `
        <div class="alert alert-info mt-3 mb-0">
            <small><i class="fas fa-calendar"></i> ${daysUntil} day${daysUntil === 1 ? '' : 's'} until your trip</small>
        </div>
        ` : ''}
    `;
}

// Load activities
async function loadActivities() {
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/activities`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            renderActivities(data.activities);
        }
    } catch (error) {
        console.error('Error loading activities:', error);
    }
}

function renderActivities(activities) {
    const container = document.getElementById('activitiesList');
    
    if (activities.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-map-marked-alt fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No activities yet</h5>
                <button class="btn btn-primary mt-3" onclick="addActivity()">
                    <i class="fas fa-plus"></i> Add First Activity
                </button>
            </div>
        `;
        return;
    }
    
    // Render as compact list
    container.innerHTML = `
        <div class="list-group">
            ${activities.map(activity => `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${activity.name}</h6>
                            <p class="mb-1 small text-muted">${activity.description || ''}</p>
                            <div class="mb-1">
                                <span class="badge bg-${getCategoryColor(activity.category)} me-1">${activity.category}</span>
                                <span class="badge bg-${getPriorityColor(activity.priority)}">${activity.priority}</span>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${new Date(activity.start_datetime).toLocaleString()}
                                ${activity.location_name ? `&nbsp;&nbsp;<i class="fas fa-map-marker-alt"></i> ${activity.location_name}` : ''}
                            </small>
                        </div>
                        ${hasPermission('activities', 'write') || hasPermission('activities', 'delete') ? `
                        <div class="btn-group ms-2">
                            ${hasPermission('activities', 'write') ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="editActivity(${activity.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            ` : ''}
                            ${hasPermission('activities', 'delete') ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteActivity(${activity.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Note: getCategoryColor and getPriorityColor are now in utils.js

// Load accommodations
async function loadAccommodations() {
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/accommodations`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            renderAccommodations(data.accommodations);
        }
    } catch (error) {
        console.error('Error loading accommodations:', error);
    }
}

function renderAccommodations(accommodations) {
    const container = document.getElementById('accommodationsList');
    
    if (accommodations.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-hotel fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No accommodations yet</h5>
                <button class="btn btn-success mt-3" onclick="addAccommodation()">
                    <i class="fas fa-plus"></i> Add First Accommodation
                </button>
            </div>
        `;
        return;
    }
    
    // Check if user has budget permission
    const hasBudgetPermission = hasPermission('budget', 'read');
    
    // Render as compact list
    container.innerHTML = `
        <div class="list-group">
            ${accommodations.map(acc => `
                <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1"><i class="fas fa-hotel"></i> ${acc.name}</h6>
                            <p class="mb-1 small">
                                <strong>Check-in:</strong> ${acc.check_in_date} ${acc.check_in_time} &nbsp;&nbsp;
                                <strong>Check-out:</strong> ${acc.check_out_date} ${acc.check_out_time}
                            </p>
                            ${acc.address ? `<p class="mb-1 small text-muted"><i class="fas fa-map-marker-alt"></i> ${acc.address}, ${acc.city}</p>` : ''}
                            ${hasBudgetPermission && acc.total_cost ? `<p class="mb-0 small"><strong>Cost:</strong> ${acc.total_cost} ${acc.currency}</p>` : ''}
                            ${acc.confirmation_number ? `<p class="mb-0 small text-muted">Confirmation: ${acc.confirmation_number}</p>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="editAccommodation(${acc.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

// Tab event listeners
document.getElementById('activities-tab').addEventListener('shown.bs.tab', loadActivities);
document.getElementById('accommodations-tab').addEventListener('shown.bs.tab', loadAccommodations);
document.getElementById('timeline-tab').addEventListener('shown.bs.tab', loadGanttChart);
document.getElementById('overview-tab').addEventListener('shown.bs.tab', initializeMap);
document.getElementById('budget-tab').addEventListener('shown.bs.tab', loadBudget);
document.getElementById('packing-tab').addEventListener('shown.bs.tab', loadPackingList);

// Initialize Gantt Chart
let ganttInstance = null;

async function loadGanttChart() {
    if (ganttInstance) return; // Already loaded
    
    try {
        // Load both activities and accommodations
        const [activitiesResponse, accommodationsResponse] = await Promise.all([
            fetch(`/api/travel/trips/${tripId}/activities`, { credentials: 'include' }),
            fetch(`/api/travel/trips/${tripId}/accommodations`, { credentials: 'include' })
        ]);
        
        const activitiesData = await activitiesResponse.json();
        const accommodationsData = await accommodationsResponse.json();
        
        const activities = activitiesData.success ? activitiesData.activities : [];
        const accommodations = accommodationsData.success ? accommodationsData.accommodations : [];
        
        if (activities.length > 0 || accommodations.length > 0) {
            renderGanttChart(activities, accommodations);
        } else {
            document.getElementById('ganttChart').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-calendar-alt fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">No activities or accommodations yet</h5>
                    <p class="text-muted">Add activities and accommodations to see them in the timeline</p>
                    <button class="btn btn-primary mt-3" onclick="addActivity()">
                        <i class="fas fa-plus"></i> Add Activity
                    </button>
                    <button class="btn btn-success mt-3 ms-2" onclick="addAccommodation()">
                        <i class="fas fa-hotel"></i> Add Accommodation
                    </button>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading gantt chart:', error);
        document.getElementById('ganttChart').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Error loading timeline
            </div>
        `;
    }
}

function renderGanttChart(activities, accommodations) {
    // Calculate date range: trip dates ± 12 hours
    let startDate = new Date(tripStartDate);
    startDate.setHours(0, 0, 0, 0); // Start at midnight of first day
    
    let endDate = new Date(tripEndDate);
    endDate.setHours(23, 59, 59, 999); // End at end of last day
    
    // Generate dates array for timeline (one entry per day)
    const dates = [];
    let current = new Date(startDate);
    while (current <= endDate) {
        dates.push(new Date(current));
        current.setDate(current.getDate() + 1);
    }
    
    // Group timeline items by category
    const timelineCategories = {
        'Accommodation': [],
        'Transport': [],
        'Activities': []
    };
    
    // Add activities to appropriate category
    activities.forEach(activity => {
        const item = {
            type: 'activity',
            id: activity.id,
            name: activity.name,
            start: new Date(activity.start_datetime),
            end: new Date(activity.end_datetime),
            category: activity.category,
            data: activity
        };
        
        // Transport category includes transport-related activities
        if (activity.category === 'transport') {
            timelineCategories['Transport'].push(item);
        } else {
            timelineCategories['Activities'].push(item);
        }
    });
    
    // Add accommodations as full stay blocks (check-in to check-out)
    accommodations.forEach(accommodation => {
        const checkIn = new Date(accommodation.check_in_date);
        const checkOut = new Date(accommodation.check_out_date);
        
        // Set check-in time if available, otherwise use 14:00 (standard check-in)
        if (accommodation.check_in_time) {
            const [hours, minutes] = accommodation.check_in_time.split(':');
            checkIn.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        } else {
            checkIn.setHours(14, 0, 0, 0);
        }
        
        // Set check-out time if available, otherwise use 11:00 (standard check-out)
        if (accommodation.check_out_time) {
            const [hours, minutes] = accommodation.check_out_time.split(':');
            checkOut.setHours(parseInt(hours), parseInt(minutes), 0, 0);
        } else {
            checkOut.setHours(11, 0, 0, 0);
        }
        
        timelineCategories['Accommodation'].push({
            type: 'accommodation',
            id: accommodation.id,
            name: '🏨 ' + accommodation.name,
            start: checkIn,
            end: checkOut,
            data: accommodation
        });
    });
    
    // Build custom timeline HTML - use full width dynamically
    const ganttContainer = document.getElementById('ganttChart');
    const containerWidth = ganttContainer.offsetWidth;
    const labelWidth = 200; // Fixed label column width
    const availableWidth = containerWidth - labelWidth - 40; // Subtract label and padding
    const cellWidth = availableWidth / dates.length; // Divide remaining space equally among dates
    const totalWidth = dates.length * cellWidth;
    const totalMs = endDate - startDate;

    let html = '<div class="timeline-container">';

    // Header with dates (flexible width cells)
    html += '<div class="timeline-header">';
    html += '<div class="timeline-label">Category</div>';
    html += '<div style="display: flex; flex: 1;">';
    dates.forEach(date => {
        html += `<div class="timeline-date" style="flex: 1; min-width: ${cellWidth}px;">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</div>`;
    });
    html += '</div></div>';

    // Rows for each category
    ['Accommodation', 'Transport', 'Activities'].forEach(categoryName => {
        const items = timelineCategories[categoryName];
        
        html += '<div class="timeline-row">';
        html += `<div class="timeline-label"><strong>${categoryName}</strong></div>`;
        // Grid uses flex to fill available width
        html += '<div class="timeline-grid" style="position: relative; height: 60px;">';

        // Add date cells for visual grid (flexible width)
        dates.forEach(() => {
            html += `<div class="timeline-cell" style="flex: 1; min-width: ${cellWidth}px;"></div>`;
        });

        // Add timeline blocks for all items in this category
        items.forEach((item, index) => {
            // Calculate position and size in pixels to avoid % rounding mismatches
            const leftPx = ((item.start - startDate) / totalMs) * totalWidth;
            const widthPx = ((item.end - item.start) / totalMs) * totalWidth;

            // Round to prevent sub-pixel gaps
            const clampedLeft = Math.round(Math.max(0, Math.min(totalWidth, leftPx)));
            const clampedWidth = Math.round(Math.max(4, Math.min(totalWidth - clampedLeft, widthPx)));

            const categoryClass = item.type === 'accommodation' ? 'accommodation' : 
                                 item.category ? item.category.toLowerCase() : 'activity';
            
            // Stack items vertically with offset
            const topOffset = (index % 3) * 20;

            const tooltipData = JSON.stringify(item.data).replace(/"/g, '&quot;');
            html += `<div class="timeline-block timeline-block-${categoryClass}" 
                          style="left: ${clampedLeft}px; width: ${clampedWidth}px; top: ${topOffset}px; height: 16px;"
                          data-type="${item.type}" 
                          data-id="${item.id}"
                          data-item='${tooltipData}'
                          onmouseenter="showTimelineTooltip(event, this)"
                          onmouseleave="hideTimelineTooltip()"
                          onclick="handle${item.type === 'activity' ? 'Activity' : 'Accommodation'}Click(${item.id})"
                          title="${item.name}">
                     </div>`;
        });

        html += '</div></div>';
    });

    html += '</div>';

    document.getElementById('ganttChart').innerHTML = html;
    
    // Enable drag-and-drop for activity blocks (not accommodations)
    enableTimelineDrag(startDate, totalWidth, totalMs);
}

// Timeline tooltip functionality
let tooltipElement = null;

function showTimelineTooltip(event, element) {
    // Don't show tooltip while dragging
    if (dragState && dragState.hasMoved) return;
    
    const type = element.dataset.type;
    const itemData = JSON.parse(element.dataset.item);
    
    // Create tooltip content based on type
    let content = '';
    
    if (type === 'activity') {
        const startDate = new Date(itemData.start_datetime);
        const endDate = new Date(itemData.end_datetime);
        const duration = itemData.duration_minutes ? `${itemData.duration_minutes} min` : 
                        Math.round((endDate - startDate) / 60000) + ' min';
        
        content = `
            <div><strong>${itemData.name}</strong></div>
            <div style="margin-top: 5px;">
                📅 ${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}<br>
                🕐 ${startDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })} - 
                    ${endDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                    (${duration})
            </div>
            ${itemData.location_name ? `<div>📍 ${itemData.location_name}</div>` : ''}
            ${itemData.category ? `<div>🏷️ ${itemData.category}</div>` : ''}
            ${itemData.cost ? `<div>💰 ${itemData.cost} ${itemData.currency || ''}</div>` : ''}
            ${itemData.notes ? `<div style="margin-top: 5px; font-size: 11px; opacity: 0.9;">${itemData.notes.substring(0, 100)}${itemData.notes.length > 100 ? '...' : ''}</div>` : ''}
        `;
    } else if (type === 'accommodation') {
        const checkIn = new Date(itemData.check_in_date);
        const checkOut = new Date(itemData.check_out_date);
        const nights = Math.round((checkOut - checkIn) / (1000 * 60 * 60 * 24));
        
        content = `
            <div><strong>🏨 ${itemData.name}</strong></div>
            <div style="margin-top: 5px;">
                ✅ Check-in: ${checkIn.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} 
                    ${itemData.check_in_time || '14:00'}<br>
                ✅ Check-out: ${checkOut.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} 
                    ${itemData.check_out_time || '11:00'}
                    (${nights} night${nights !== 1 ? 's' : ''})
            </div>
            ${itemData.address ? `<div>📍 ${itemData.address}, ${itemData.city || ''}</div>` : ''}
            ${itemData.total_cost ? `<div>💰 ${itemData.total_cost} ${itemData.currency || ''}</div>` : ''}
            ${itemData.confirmation_number ? `<div>🎫 ${itemData.confirmation_number}</div>` : ''}
        `;
    }
    
    // Create or update tooltip
    if (!tooltipElement) {
        tooltipElement = document.createElement('div');
        tooltipElement.className = 'timeline-tooltip';
        document.body.appendChild(tooltipElement);
    }
    
    tooltipElement.innerHTML = content;
    tooltipElement.style.display = 'block';
    
    // Position tooltip above the element
    const rect = element.getBoundingClientRect();
    const tooltipRect = tooltipElement.getBoundingClientRect();
    
    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);
    let top = rect.top - tooltipRect.height - 10;
    
    // Keep tooltip on screen
    if (left < 10) left = 10;
    if (left + tooltipRect.width > window.innerWidth - 10) {
        left = window.innerWidth - tooltipRect.width - 10;
    }
    if (top < 10) {
        top = rect.bottom + 10; // Show below if not enough space above
    }
    
    tooltipElement.style.left = left + 'px';
    tooltipElement.style.top = top + 'px';
}

function hideTimelineTooltip() {
    if (tooltipElement) {
        tooltipElement.style.display = 'none';
    }
}

// Timeline drag-and-drop functionality
let dragState = null;

function enableTimelineDrag(timelineStart, totalWidth, totalMs) {
    const activityBlocks = document.querySelectorAll('.timeline-block-sightseeing, .timeline-block-dining, .timeline-block-transport, .timeline-block-entertainment, .timeline-block-shopping, .timeline-block-activity');
    
    activityBlocks.forEach(block => {
        block.style.cursor = 'move';
        
        block.addEventListener('mousedown', (e) => {
            // Only drag with left mouse button, not on click for edit
            if (e.button !== 0) return;
            
            const activityId = parseInt(block.dataset.id);
            const rect = block.getBoundingClientRect();
            const gridRect = block.parentElement.getBoundingClientRect();
            
            dragState = {
                activityId: activityId,
                block: block,
                startX: e.clientX,
                startLeft: parseFloat(block.style.left) || 0,
                gridLeft: gridRect.left,
                totalWidth: totalWidth,
                totalMs: totalMs,
                timelineStart: timelineStart,
                hasMoved: false
            };
            
            e.preventDefault();
            e.stopPropagation();
        });
    });
    
    document.addEventListener('mousemove', onDragMove);
    document.addEventListener('mouseup', onDragEnd);
}

function onDragMove(e) {
    if (!dragState) return;
    
    const deltaX = e.clientX - dragState.startX;
    if (Math.abs(deltaX) > 3) {
        dragState.hasMoved = true;
        hideTimelineTooltip(); // Hide tooltip when dragging starts
    }
    
    if (dragState.hasMoved) {
        const newLeft = Math.max(0, Math.min(dragState.totalWidth - parseFloat(dragState.block.style.width), dragState.startLeft + deltaX));
        dragState.block.style.left = newLeft + 'px';
        dragState.block.style.opacity = '0.7';
    }
}

async function onDragEnd(e) {
    if (!dragState) return;
    
    // If it was just a click (no movement), treat as click to edit
    if (!dragState.hasMoved) {
        dragState.block.style.opacity = '';
        dragState = null;
        return; // Let the onclick handler fire
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    const block = dragState.block;
    const activityId = dragState.activityId;
    
    // Calculate new dates based on pixel position
    const newLeftPx = parseFloat(block.style.left);
    const widthPx = parseFloat(block.style.width);
    
    const startMs = dragState.timelineStart.getTime() + (newLeftPx / dragState.totalWidth) * dragState.totalMs;
    const endMs = startMs + (widthPx / dragState.totalWidth) * dragState.totalMs;
    
    const newStartDate = new Date(startMs);
    const newEndDate = new Date(endMs);
    
    // Update via API
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/activities/${activityId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                start_datetime: newStartDate.toISOString(),
                end_datetime: newEndDate.toISOString()
            })
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Activity rescheduled!', 'success');
            block.style.opacity = '';
            
            // Reload timeline after short delay
            setTimeout(() => {
                ganttInstance = null;
                loadGanttChart();
            }, 300);
        } else {
            showToast('Failed to reschedule activity', 'error');
            block.style.opacity = '';
        }
    } catch (error) {
        console.error('Error updating activity:', error);
        showToast('Failed to reschedule activity', 'error');
        block.style.opacity = '';
    }
    
    dragState = null;
}

// Helper functions for timeline clicks
function handleActivityClick(activityId) {
    editActivity(activityId);
}

function handleAccommodationClick(accommodationId) {
    editAccommodation(accommodationId);
}


async function updateActivityDates(activityId, startDate, endDate) {
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/activities/${activityId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                start_datetime: startDate.toISOString(),
                end_datetime: endDate.toISOString()
            })
        });
        
        const data = await response.json();
        if (data.success) {
            console.log('Activity dates updated successfully');
            showToast('Activity dates updated!', 'success');
        }
    } catch (error) {
        console.error('Error updating activity dates:', error);
        alert('Failed to update activity dates');
    }
}

// Initialize Map
let mapInstance = null;
let markersLayer = null;

async function initializeMap() {
    if (mapInstance) return; // Already initialized
    
    // Initialize Leaflet map
    mapInstance = L.map('tripMap').setView([51.505, -0.09], 13);
    
    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(mapInstance);
    
    // Create a layer group for markers
    markersLayer = L.layerGroup().addTo(mapInstance);
    
    // Load and display markers
    await loadMapMarkers();
}

async function loadMapMarkers() {
    try {
        // Load accommodations
        const accomResponse = await fetch(`/api/travel/trips/${tripId}/accommodations`, {
            credentials: 'include'
        });
        const accomData = await accomResponse.json();
        
        // Load activities
        const actResponse = await fetch(`/api/travel/trips/${tripId}/activities`, {
            credentials: 'include'
        });
        const actData = await actResponse.json();
        
        const bounds = [];
        
        // Add accommodation markers
        if (accomData.success && accomData.accommodations) {
            accomData.accommodations.forEach(acc => {
                if (acc.latitude && acc.longitude) {
                    const marker = L.marker([acc.latitude, acc.longitude], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(markersLayer);
                    
                    marker.bindPopup(`
                        <strong><i class="fas fa-hotel"></i> ${acc.name}</strong><br>
                        ${acc.address || ''}<br>
                        <small>Check-in: ${acc.check_in_date}</small>
                    `);
                    
                    bounds.push([acc.latitude, acc.longitude]);
                }
            });
        }
        
        // Add activity markers
        if (actData.success && actData.activities) {
            actData.activities.forEach(act => {
                if (act.latitude && act.longitude) {
                    const marker = L.marker([act.latitude, act.longitude], {
                        icon: L.icon({
                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        })
                    }).addTo(markersLayer);
                    
                    marker.bindPopup(`
                        <strong><i class="fas fa-map-marker-alt"></i> ${act.name}</strong><br>
                        ${act.location || ''}<br>
                        <small>${act.start_date} ${act.start_time || ''}</small><br>
                        <span class="badge bg-${getCategoryColor(act.category)}">${act.category}</span>
                    `);
                    
                    bounds.push([act.latitude, act.longitude]);
                }
            });
        }
        
        // Fit map to show all markers
        if (bounds.length > 0) {
            mapInstance.fitBounds(bounds, { padding: [50, 50] });
        } else {
            // Default to trip destination if available
            if (typeof tripCity !== 'undefined' && typeof tripCountry !== 'undefined') {
                // Use Nominatim to geocode the destination
                geocodeDestination(tripCity, tripCountry);
            }
        }
    } catch (error) {
        console.error('Error loading map markers:', error);
    }
}

async function geocodeDestination(city, country) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&format=json&limit=1`);
        const data = await response.json();
        
        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            mapInstance.setView([lat, lon], 12);
            
            // Add a marker for the destination
            L.marker([lat, lon]).addTo(markersLayer)
                .bindPopup(`<strong>${city}, ${country}</strong>`)
                .openPopup();
        }
    } catch (error) {
        console.error('Error geocoding destination:', error);
    }
}

// Tab event listeners
document.getElementById('activities-tab').addEventListener('shown.bs.tab', loadActivities);
document.getElementById('accommodations-tab').addEventListener('shown.bs.tab', loadAccommodations);

// Activity Modal Functions
let activityModal, accommodationModal, expenseModal, packingModal;

document.addEventListener('DOMContentLoaded', function() {
    // Modals are now initialized in init.js
    
    // Initialize map on page load since overview tab is active by default
    initializeMap();
    
    // Fix Leaflet map size after container resizes
    setTimeout(function() {
        if (mapInstance) {
            mapInstance.invalidateSize();
        }
    }, 300);
    
    // Attach autocompletes for activity and accommodation location fields
    // For activity: activityLocation serves as both search input and location_name field
    attachCityAutocomplete('activityLocation', 'activityCity', 'activityCountry', 'activityLatitude', 'activityLongitude', null);
    // For accommodation: accommodationAddress is the search field, we'll also use it as the address
    attachCityAutocomplete('accommodationAddress', 'accommodationCity', 'accommodationCountry', 'accommodationLatitude', 'accommodationLongitude', null);
});

function addActivity() {
    // Reset form
    document.getElementById('activityForm').reset();
    document.getElementById('activityId').value = '';
    document.getElementById('activityModalLabel').textContent = 'Add Activity';
    document.getElementById('deleteActivityBtn').style.display = 'none';
    
    // Set default dates to trip dates
    const tripStart = '{{ trip.start_date }}';
    const tripEnd = '{{ trip.end_date }}';
    if (tripStart) document.getElementById('activityStartDate').value = tripStart;
    if (tripEnd) document.getElementById('activityEndDate').value = tripEnd;
    
    activityModal.show();
}

async function editActivity(id) {
    // Check permission
    if (!hasPermission('activities', 'write')) {
        showToast('No permission to edit activities', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/activities/${id}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            const activity = data.activity;
            
            // Split datetime into date and time
            let startDate = '', startTime = '', endDate = '', endTime = '';
            
            if (activity.start_datetime) {
                const start = new Date(activity.start_datetime);
                startDate = start.toISOString().split('T')[0];
                startTime = start.toTimeString().slice(0, 5);
            }
            
            if (activity.end_datetime) {
                const end = new Date(activity.end_datetime);
                endDate = end.toISOString().split('T')[0];
                endTime = end.toTimeString().slice(0, 5);
            }
            
            // Populate form
            document.getElementById('activityId').value = activity.id;
            document.getElementById('activityName').value = activity.name || '';
            document.getElementById('activityCategory').value = activity.category || 'other';
            document.getElementById('activityDescription').value = activity.description || '';
            document.getElementById('activityStartDate').value = startDate;
            document.getElementById('activityStartTime').value = startTime;
            document.getElementById('activityEndDate').value = endDate;
            document.getElementById('activityEndTime').value = endTime;
            document.getElementById('activityLocation').value = activity.location_name || '';
            document.getElementById('activityCity').value = activity.city || '';
            document.getElementById('activityCountry').value = activity.country || '';
            document.getElementById('activityAddress').value = activity.address || '';
            document.getElementById('activityLatitude').value = activity.latitude || '';
            document.getElementById('activityLongitude').value = activity.longitude || '';
            document.getElementById('activityPriority').value = activity.priority || 'medium';
            document.getElementById('activityCost').value = activity.cost || '';
            // Convert duration from minutes to hours for display
            document.getElementById('activityDuration').value = activity.duration_minutes ? (activity.duration_minutes / 60) : '';
            document.getElementById('activityNotes').value = activity.notes || '';
            
            document.getElementById('activityModalLabel').textContent = 'Edit Activity';
            document.getElementById('deleteActivityBtn').style.display = 'inline-block';
            
            activityModal.show();
        }
    } catch (error) {
        console.error('Error loading activity:', error);
        alert('Failed to load activity details');
    }
}

// Helper function to add location to weather tracking system
async function addLocationToWeather(city, country, latitude, longitude) {
    if (!city || !country || !latitude || !longitude) {
        return; // Skip if required data is missing
    }
    
    try {
        const response = await fetch('/weather/api/locations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({
                city_name: city,
                country: country,
                latitude: parseFloat(latitude),
                longitude: parseFloat(longitude)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log(`✓ Location ${city}, ${country} added to weather tracking`);
            showToast(`📍 ${city}, ${country} added to weather tracking!`, 'info');
        } else if (result.error && result.error.includes('already exists')) {
            console.log(`✓ Location ${city}, ${country} already in weather tracking`);
        } else {
            console.warn(`Could not add ${city}, ${country} to weather tracking:`, result.error);
        }
    } catch (error) {
        console.warn('Failed to add location to weather tracking:', error);
        // Don't throw - this is a non-critical feature
    }
}

// Generic location autocomplete hookup using the enhanced location search endpoint
// This supports addresses, POIs, landmarks, hotels, attractions, not just cities
function attachCityAutocomplete(inputId, cityFieldId, countryFieldId, latFieldId, lonFieldId, locationNameFieldId) {
    const input = document.getElementById(inputId);
    if (!input) return;

    // Create dropdown
    let dropdown = document.createElement('div');
    dropdown.className = 'suggestions-dropdown position-absolute bg-white border shadow-sm';
    dropdown.style.zIndex = 1050;
    dropdown.style.display = 'none';
    dropdown.style.maxHeight = '300px';
    dropdown.style.overflow = 'auto';
    dropdown.style.width = '100%';
    dropdown.style.maxWidth = '500px';
    input.parentNode.style.position = 'relative';
    input.parentNode.appendChild(dropdown);

    let debounceTimer = null;

    input.addEventListener('input', (e) => {
        const q = input.value.trim();
        if (debounceTimer) clearTimeout(debounceTimer);
        if (q.length < 3) {
            dropdown.style.display = 'none';
            return;
        }
        debounceTimer = setTimeout(async () => {
            try {
                // Use the more permissive location search endpoint
                const resp = await fetch(`/weather/api/search-locations?q=${encodeURIComponent(q)}`);
                const json = await resp.json();
                const locations = (json && json.locations) ? json.locations : [];
                renderSuggestions(locations);
            } catch (err) {
                console.warn('Autocomplete error', err);
                dropdown.style.display = 'none';
            }
        }, 300);
    });

    input.addEventListener('blur', () => {
        // Slight delay so click can register
        setTimeout(() => { dropdown.style.display = 'none'; }, 200);
    });

    input.addEventListener('focus', (e) => {
        // Re-show dropdown if we have content
        if (dropdown.children.length > 0 && input.value.trim().length >= 3) {
            dropdown.style.display = 'block';
        }
    });

    function renderSuggestions(locations) {
        dropdown.innerHTML = '';
        if (!locations || locations.length === 0) {
            dropdown.innerHTML = '<div class="p-2 text-muted small">No results found. Try a more specific address or landmark name.</div>';
            dropdown.style.display = 'block';
            return;
        }

        locations.forEach(location => {
            const item = document.createElement('div');
            item.className = 'p-2 suggestion-item border-bottom';
            item.style.cursor = 'pointer';
            
            // Create rich display with type icon and full address
            const nameHtml = location.name ? `<div class="fw-bold">${location.type ? location.type + ' ' : ''}${location.name}</div>` : '';
            const addressHtml = `<div class="small text-muted">${location.full_address}</div>`;
            
            item.innerHTML = nameHtml + addressHtml;
            
            item.addEventListener('click', () => {
                select(location);
            });
            dropdown.appendChild(item);
        });
        dropdown.style.display = 'block';
    }

    function select(location) {
        // Fill the search input with the full address
        input.value = location.full_address;
        
        // Fill location name field if provided (for specific places like "Eiffel Tower")
        if (locationNameFieldId) {
            const nameField = document.getElementById(locationNameFieldId);
            if (nameField) {
                nameField.value = location.name || location.full_address;
            }
        }
        
        // Fill city, country, coordinates
        if (cityFieldId) document.getElementById(cityFieldId).value = location.city || '';
        if (countryFieldId) document.getElementById(countryFieldId).value = location.country || '';
        if (latFieldId) document.getElementById(latFieldId).value = location.latitude || '';
        if (lonFieldId) document.getElementById(lonFieldId).value = location.longitude || '';
        
        dropdown.style.display = 'none';
    }
}

async function saveActivity() {
    const form = document.getElementById('activityForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const activityId = document.getElementById('activityId').value;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Remove the id field from data (it's in the URL)
    delete data.id;
    
    // Combine date and time fields into datetime
    if (data.start_date) {
        const startTime = data.start_time || '09:00';
        data.start_datetime = `${data.start_date}T${startTime}:00`;
        delete data.start_date;
        delete data.start_time;
    }
    
    if (data.end_date) {
        const endTime = data.end_time || '17:00';
        data.end_datetime = `${data.end_date}T${endTime}:00`;
        delete data.end_date;
        delete data.end_time;
    }
    
    // Convert duration from hours to minutes
    if (data.duration_minutes && data.duration_minutes !== '') {
        data.duration_minutes = Math.round(parseFloat(data.duration_minutes) * 60);
    }
    
    // Remove empty fields
    Object.keys(data).forEach(key => {
        if (data[key] === '' || data[key] === null) {
            delete data[key];
        }
    });
    
    try {
        const url = activityId 
            ? `/api/travel/trips/${tripId}/activities/${activityId}`
            : `/api/travel/trips/${tripId}/activities`;
        const method = activityId ? 'PUT' : 'POST';
        
        console.log(`${method} ${url}`, data);
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add location to weather tracking if city/country/coordinates provided
            if (data.city && data.country && data.latitude && data.longitude) {
                await addLocationToWeather(data.city, data.country, data.latitude, data.longitude);
            }
            
            // Hide modal first
            activityModal.hide();
            
            // Wait for modal to close before refreshing
            setTimeout(async () => {
                // Reload activities list
                await loadActivities();
                
                // Refresh Gantt chart if visible
                if (ganttInstance) {
                    ganttInstance = null;
                    await loadGanttChart();
                }
                
                // Refresh map markers
                if (mapInstance && markersLayer) {
                    markersLayer.clearLayers();
                    await loadMapMarkers();
                }
                
                // Show success message
                const message = activityId ? 'Activity updated successfully!' : 'Activity added successfully!';
                showToast(message, 'success');
            }, 300);
        } else {
            alert('Error: ' + (result.error || 'Failed to save activity'));
        }
    } catch (error) {
        console.error('Error saving activity:', error);
        alert('Failed to save activity: ' + error.message);
    }
}

async function deleteActivityConfirm() {
    if (!confirm('Are you sure you want to delete this activity?')) {
        return;
    }
    
    const activityId = document.getElementById('activityId').value;
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/activities/${activityId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        
        if (result.success) {
            activityModal.hide();
            
            setTimeout(async () => {
                await loadActivities();
                
                // Refresh Gantt chart
                if (ganttInstance) {
                    ganttInstance = null;
                    await loadGanttChart();
                }
                
                // Refresh map
                if (mapInstance && markersLayer) {
                    markersLayer.clearLayers();
                    await loadMapMarkers();
                }
                
                showToast('Activity deleted successfully!', 'success');
            }, 300);
        } else {
            alert('Error: ' + (result.error || 'Failed to delete activity'));
        }
    } catch (error) {
        console.error('Error deleting activity:', error);
        alert('Failed to delete activity');
    }
}

// Accommodation Modal Functions
function addAccommodation() {
    // Reset form
    document.getElementById('accommodationForm').reset();
    document.getElementById('accommodationId').value = '';
    document.getElementById('accommodationModalLabel').textContent = 'Add Accommodation';
    document.getElementById('deleteAccommodationBtn').style.display = 'none';
    
    // Set default dates
    const tripStart = '{{ trip.start_date }}';
    const tripEnd = '{{ trip.end_date }}';
    if (tripStart) document.getElementById('accommodationCheckIn').value = tripStart;
    if (tripEnd) document.getElementById('accommodationCheckOut').value = tripEnd;
    
    accommodationModal.show();
}

async function editAccommodation(id) {
    // Check permission
    if (!hasPermission('accommodations', 'write')) {
        showToast('No permission to edit accommodations', 'error');
        return;
    }
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/accommodations/${id}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            const acc = data.accommodation;
            
            // Populate form
            document.getElementById('accommodationId').value = acc.id;
            document.getElementById('accommodationName').value = acc.name || '';
            document.getElementById('accommodationType').value = acc.accommodation_type || 'hotel';
            document.getElementById('accommodationAddress').value = acc.address || '';
            document.getElementById('accommodationCity').value = acc.city || '';
            document.getElementById('accommodationCountry').value = acc.country || '';
            document.getElementById('accommodationLatitude').value = acc.latitude || '';
            document.getElementById('accommodationLongitude').value = acc.longitude || '';
            document.getElementById('accommodationPhone').value = acc.phone || '';
            document.getElementById('accommodationWebsite').value = acc.website || '';
            document.getElementById('accommodationCheckIn').value = acc.check_in_date || '';
            document.getElementById('accommodationCheckInTime').value = acc.check_in_time || '15:00';
            document.getElementById('accommodationCheckOut').value = acc.check_out_date || '';
            document.getElementById('accommodationCheckOutTime').value = acc.check_out_time || '11:00';
            document.getElementById('accommodationCost').value = acc.total_cost || '';
            document.getElementById('accommodationCurrency').value = acc.currency || 'USD';
            document.getElementById('accommodationConfirmation').value = acc.confirmation_number || '';
            document.getElementById('accommodationStatus').value = acc.booking_status || 'confirmed';
            document.getElementById('accommodationNotes').value = acc.notes || '';
            
            document.getElementById('accommodationModalLabel').textContent = 'Edit Accommodation';
            document.getElementById('deleteAccommodationBtn').style.display = 'inline-block';
            
            accommodationModal.show();
        }
    } catch (error) {
        console.error('Error loading accommodation:', error);
        alert('Failed to load accommodation details');
    }
}

async function saveAccommodation() {
    const form = document.getElementById('accommodationForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const accommodationId = document.getElementById('accommodationId').value;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Remove the id field from data (it's in the URL)
    delete data.id;
    
    // Remove empty fields
    Object.keys(data).forEach(key => {
        if (data[key] === '' || data[key] === null) {
            delete data[key];
        }
    });
    
    try {
        const url = accommodationId 
            ? `/api/travel/trips/${tripId}/accommodations/${accommodationId}`
            : `/api/travel/trips/${tripId}/accommodations`;
        const method = accommodationId ? 'PUT' : 'POST';
        
        console.log(`${method} ${url}`, data);
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add location to weather tracking if city/country/coordinates provided
            if (data.city && data.country && data.latitude && data.longitude) {
                await addLocationToWeather(data.city, data.country, data.latitude, data.longitude);
            }
            
            // Hide modal first
            accommodationModal.hide();
            
            // Wait for modal to close before refreshing
            setTimeout(async () => {
                // Reload accommodations list
                await loadAccommodations();
                
                // Refresh map markers
                if (mapInstance && markersLayer) {
                    markersLayer.clearLayers();
                    await loadMapMarkers();
                }
                
                // Show success message
                const message = accommodationId ? 'Accommodation updated successfully!' : 'Accommodation added successfully!';
                showToast(message, 'success');
            }, 300);
        } else {
            alert('Error: ' + (result.error || 'Failed to save accommodation'));
        }
    } catch (error) {
        console.error('Error saving accommodation:', error);
        alert('Failed to save accommodation: ' + error.message);
    }
}

async function deleteAccommodationConfirm() {
    if (!confirm('Are you sure you want to delete this accommodation?')) {
        return;
    }
    
    const accommodationId = document.getElementById('accommodationId').value;
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/accommodations/${accommodationId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const result = await response.json();
        
        if (result.success) {
            accommodationModal.hide();
            
            setTimeout(async () => {
                await loadAccommodations();
                
                // Refresh map
                if (mapInstance && markersLayer) {
                    markersLayer.clearLayers();
                    await loadMapMarkers();
                }
                
                showToast('Accommodation deleted successfully!', 'success');
            }, 300);
        } else {
            alert('Error: ' + (result.error || 'Failed to delete accommodation'));
        }
    } catch (error) {
        console.error('Error deleting accommodation:', error);
        alert('Failed to delete accommodation');
    }
}

// Placeholder functions for other features
function addExpense() {
    alert('Expense tracking will be implemented in a future update');
}

function addPackingItem() {
    alert('Packing list will be implemented in a future update');
}

function deleteActivity(id) {
    // Check permission
    if (!hasPermission('activities', 'delete')) {
        showToast('No permission to delete activities', 'error');
        return;
    }
    
    editActivity(id);
}

// Note: showToast() and createToastContainer() now in utils.js
// Note: getRoleBadgeColor() now in utils.js


// ===== BUDGET TAB FUNCTIONS =====
let budgetLoaded = false;

async function loadBudget(force = false) {
    if (budgetLoaded && !force) return;
    
    try {
        const currency = '{{ trip.budget_currency }}' || 'EUR';
        const totalBudget = parseFloat('{{ trip.budget_total }}') || 0;
        
        // Load all data in parallel
        const [activitiesResp, accommodationsResp, expensesResp] = await Promise.all([
            fetch(`/api/travel/trips/${tripId}/activities`, { credentials: 'include' }),
            fetch(`/api/travel/trips/${tripId}/accommodations`, { credentials: 'include' }),
            fetch(`/api/travel/trips/${tripId}/expenses`, { credentials: 'include' })
        ]);
        
        const activitiesData = await activitiesResp.json();
        const accommodationsData = await accommodationsResp.json();
        const expensesData = await expensesResp.json();
        
        // Calculate planned costs
        const activities = activitiesData.success ? activitiesData.activities : [];
        const accommodations = accommodationsData.success ? accommodationsData.accommodations : [];
        const expenses = expensesData.success ? expensesData.expenses : [];
        
        const activityCosts = activities.reduce((sum, a) => sum + (parseFloat(a.cost) || 0), 0);
        const accommodationCosts = accommodations.reduce((sum, a) => sum + (parseFloat(a.total_cost) || 0), 0);
        const plannedCosts = activityCosts + accommodationCosts;
        
        const otherExpenses = expenses.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
        const totalSpent = plannedCosts + otherExpenses;
        const remaining = totalBudget - totalSpent;
        
        // Update summary cards
        document.getElementById('budgetTotal').textContent = `${totalBudget.toFixed(2)} ${currency}`;
        document.getElementById('plannedCosts').textContent = `${plannedCosts.toFixed(2)} ${currency}`;
        document.getElementById('otherExpenses').textContent = `${otherExpenses.toFixed(2)} ${currency}`;
        document.getElementById('budgetRemaining').textContent = `${remaining.toFixed(2)} ${currency}`;
        
        // Update remaining card color
        const remainingCard = document.getElementById('budgetRemaining');
        if (remaining < 0) {
            remainingCard.className = 'text-danger';
        } else if (remaining < totalBudget * 0.2) {
            remainingCard.className = 'text-warning';
        } else {
            remainingCard.className = 'text-success';
        }
        
        // Update breakdown
        document.getElementById('accommodationCosts').textContent = `${accommodationCosts.toFixed(2)} ${currency}`;
        document.getElementById('activityCosts').textContent = `${activityCosts.toFixed(2)} ${currency}`;
        
        if (plannedCosts > 0) {
            const accommodationPct = (accommodationCosts / plannedCosts * 100).toFixed(0);
            const activityPct = (activityCosts / plannedCosts * 100).toFixed(0);
            document.getElementById('accommodationProgress').style.width = accommodationPct + '%';
            document.getElementById('activityProgress').style.width = activityPct + '%';
        }
        
        // Expense category summary
        const categorySummary = {};
        expenses.forEach(e => {
            const cat = e.category || 'Other';
            if (!categorySummary[cat]) categorySummary[cat] = 0;
            categorySummary[cat] += parseFloat(e.amount) || 0;
        });
        
        const summaryDiv = document.getElementById('expenseCategorySummary');
        if (Object.keys(categorySummary).length > 0) {
            let summaryHTML = '';
            Object.entries(categorySummary).forEach(([cat, amt]) => {
                summaryHTML += `
                    <div class="d-flex justify-content-between mb-1">
                        <span>${cat}</span>
                        <strong>${amt.toFixed(2)} ${currency}</strong>
                    </div>
                `;
            });
            summaryDiv.innerHTML = summaryHTML;
        } else {
            summaryDiv.innerHTML = '<p class="text-muted text-center mb-0">No expenses yet</p>';
        }
        
        // Render expenses list
        renderExpenses(expenses, currency);
        
        budgetLoaded = true;
    } catch (error) {
        console.error('Error loading budget:', error);
        document.getElementById('expensesList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Error loading budget data
            </div>
        `;
    }
}

function renderExpenses(expenses, currency) {
    const container = document.getElementById('expensesList');
    
    if (expenses.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-wallet fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No additional expenses yet</h5>
                <p class="text-muted">Track your trip expenses here</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = expenses.map(expense => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="mb-1">${expense.description}</h5>
                        <p class="text-muted mb-2">
                            <i class="fas fa-calendar"></i> ${expense.expense_date}
                            ${expense.category ? `<span class="badge bg-secondary ms-2">${expense.category}</span>` : ''}
                        </p>
                    </div>
                    <div class="text-end">
                        <h4 class="mb-0">${parseFloat(expense.amount).toFixed(2)} ${expense.currency || currency}</h4>
                        <div class="btn-group btn-group-sm mt-2">
                            <button class="btn btn-outline-primary" onclick="editExpense(${expense.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteExpense(${expense.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                ${expense.notes ? `<p class="mb-0 mt-2"><small>${expense.notes}</small></p>` : ''}
            </div>
        </div>
    `).join('');
}

function addExpense() {
    document.getElementById('expenseForm').reset();
    document.getElementById('expenseId').value = '';
    document.getElementById('expenseModalLabel').textContent = 'Add Expense';
    document.getElementById('deleteExpenseBtn').style.display = 'none';
    
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expenseDate').value = today;
    
    const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
    modal.show();
}

async function editExpense(id) {
    try {
        // Fetch expense data
        const response = await fetch(`/api/travel/trips/${tripId}/expenses`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            const expense = data.expenses.find(e => e.id === id);
            if (!expense) {
                showToast('Expense not found', 'error');
                return;
            }
            
            // Populate form
            document.getElementById('expenseId').value = expense.id;
            document.getElementById('expenseDescription').value = expense.description || '';
            document.getElementById('expenseAmount').value = expense.amount || '';
            document.getElementById('expenseCurrency').value = expense.currency || '';
            document.getElementById('expenseDate').value = expense.expense_date || '';
            document.getElementById('expenseCategory').value = expense.category || '';
            document.getElementById('expenseNotes').value = expense.notes || '';
            
            document.getElementById('expenseModalLabel').textContent = 'Edit Expense';
            document.getElementById('deleteExpenseBtn').style.display = 'inline-block';
            
            const modal = new bootstrap.Modal(document.getElementById('expenseModal'));
            modal.show();
        }
    } catch (error) {
        console.error('Error loading expense:', error);
        showToast('Failed to load expense', 'error');
    }
}

async function saveExpense() {
    const form = document.getElementById('expenseForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const expenseId = document.getElementById('expenseId').value;
    const isEdit = expenseId !== '';
    
    const data = {
        description: document.getElementById('expenseDescription').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        currency: document.getElementById('expenseCurrency').value,
        expense_date: document.getElementById('expenseDate').value,
        category: document.getElementById('expenseCategory').value,
        notes: document.getElementById('expenseNotes').value
    };
    
    try {
        let response;
        if (isEdit) {
            response = await fetch(`/api/travel/expenses/${expenseId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
        } else {
            response = await fetch(`/api/travel/trips/${tripId}/expenses`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(data)
            });
        }
        
        const result = await response.json();
        if (result.success) {
            showToast(isEdit ? 'Expense updated!' : 'Expense added!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
            
            // Reload budget with force
            setTimeout(() => {
                loadBudget(true);
            }, 300);
        } else {
            showToast(result.error || 'Failed to save expense', 'error');
        }
    } catch (error) {
        console.error('Error saving expense:', error);
        showToast('Failed to save expense', 'error');
    }
}

function confirmDeleteExpense() {
    const expenseId = document.getElementById('expenseId').value;
    if (confirm('Are you sure you want to delete this expense?')) {
        deleteExpense(expenseId);
        bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
    }
}

async function deleteExpense(id) {
    if (!confirm('Delete this expense?')) return;
    
    try {
        const response = await fetch(`/api/travel/expenses/${id}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const data = await response.json();
        if (data.success) {
            showToast('Expense deleted', 'success');
            loadBudget(true);
        }
    } catch (error) {
        console.error('Error deleting expense:', error);
        showToast('Failed to delete expense', 'error');
    }
}

// ===== PACKING LIST TAB FUNCTIONS =====
let packingLoaded = false;

async function loadPackingList(force = false) {
    if (packingLoaded && !force) return;
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/packing`, {
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
            const items = data.items || [];
            const summary = data.summary || [];
            
            // Update progress
            const totalItems = items.length;
            const packedItems = items.filter(i => i.is_packed).length;
            const progressPct = totalItems > 0 ? (packedItems / totalItems * 100).toFixed(0) : 0;
            
            document.getElementById('packingProgress').textContent = `${packedItems} / ${totalItems} items packed`;
            document.getElementById('packingProgressBar').style.width = progressPct + '%';
            document.getElementById('packingProgressText').textContent = progressPct + '%';
            
            // Render packing list
            renderPackingList(items);
            
            packingLoaded = true;
        }
    } catch (error) {
        console.error('Error loading packing list:', error);
        document.getElementById('packingList').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Error loading packing list
            </div>
        `;
    }
}

function renderPackingList(items) {
    const container = document.getElementById('packingList');
    
    if (items.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-suitcase fa-4x text-muted mb-3"></i>
                <h5 class="text-muted">No packing items yet</h5>
                <p class="text-muted">Start building your packing list</p>
            </div>
        `;
        return;
    }
    
    // Group by category
    const categories = {};
    items.forEach(item => {
        const cat = item.category || 'Other';
        if (!categories[cat]) categories[cat] = [];
        categories[cat].push(item);
    });
    
    let html = '<div class="list-group">';
    Object.entries(categories).forEach(([category, catItems]) => {
        const packedCount = catItems.filter(i => i.is_packed).length;
        const totalCount = catItems.length;
        
        // Category header as list item
        html += `
            <div class="list-group-item bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <strong><i class="fas fa-tag"></i> ${category}</strong>
                    <span class="badge bg-primary">${packedCount} / ${totalCount} packed</span>
                </div>
            </div>
        `;
        
        catItems.forEach(item => {
            html += `
                <div class="list-group-item">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               id="pack-${item.id}" 
                               ${item.is_packed ? 'checked' : ''}
                               onchange="togglePackingItem(${item.id})">
                        <label class="form-check-label ${item.is_packed ? 'text-decoration-line-through text-muted' : ''}" 
                               for="pack-${item.id}">
                            ${item.item_name}
                            ${item.quantity > 1 ? `<span class="badge bg-secondary ms-2">${item.quantity}</span>` : ''}
                            ${item.notes ? `<br><small class="text-muted">${item.notes}</small>` : ''}
                        </label>
                    </div>
                </div>
            `;
        });
    });
    
    html += '</div>';
    container.innerHTML = html;
}

async function togglePackingItem(itemId) {
    try {
        const response = await fetch(`/api/travel/packing/${itemId}/toggle`, {
            method: 'POST',
            credentials: 'include'
        });
        
        const data = await response.json();
        if (data.success) {
            loadPackingList(true);
        }
    } catch (error) {
        console.error('Error toggling packing item:', error);
        showToast('Failed to update item', 'error');
    }
}

function addPackingItem() {
    document.getElementById('packingForm').reset();
    document.getElementById('packingItemId').value = '';
    document.getElementById('packingModalLabel').textContent = 'Add Packing Item';
    document.getElementById('packingQuantity').value = '1';
    
    const modal = new bootstrap.Modal(document.getElementById('packingModal'));
    modal.show();
}

async function savePackingItem() {
    const form = document.getElementById('packingForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const data = {
        item_name: document.getElementById('packingItemName').value,
        category: document.getElementById('packingCategory').value,
        quantity: parseInt(document.getElementById('packingQuantity').value) || 1,
        notes: document.getElementById('packingNotes').value,
        is_packed: false
    };
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/packing`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('Packing item added!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('packingModal')).hide();
            
            // Reload packing list
            setTimeout(() => {
                loadPackingList(true);
            }, 300);
        } else {
            showToast(result.error || 'Failed to save item', 'error');
        }
    } catch (error) {
        console.error('Error saving packing item:', error);
        showToast('Failed to save item', 'error');
    }
}

// =============================================================================
// TRIP SHARING FUNCTIONS
// =============================================================================

let shareModal, permissionModal;
let userSearchTimeout;

function openShareModal() {
    if (!shareModal) {
        shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
    }
    shareModal.show();
    loadShares();
}

async function loadShares() {
    const container = document.getElementById('sharesList');
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/shares`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'include'
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.shares && data.shares.length > 0) {
            container.innerHTML = data.shares.map(share => `
                <div class="card mb-2">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                    <i class="fas fa-user"></i> ${share.username}
                                </h6>
                                <small class="text-muted">${share.email}</small>
                                <div class="mt-1">
                                    <span class="badge bg-${getRoleBadgeColor(share.role)}">${share.role}</span>
                                    <small class="text-muted ms-2">
                                        Shared ${new Date(share.shared_at).toLocaleDateString()}
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button class="btn btn-sm btn-outline-primary" onclick="editPermissions(${share.share_id}, '${share.email}', ${JSON.stringify(share.permissions).replace(/"/g, '&quot;')})">
                                    <i class="fas fa-key"></i> Permissions
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="revokeAccess(${share.share_id}, '${share.username}')">
                                    <i class="fas fa-user-times"></i> Revoke
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-users-slash fa-2x mb-2"></i>
                    <p>This trip hasn't been shared with anyone yet.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading shares:', error);
        container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Failed to load shares: ${error.message}
            </div>
        `;
    }
}

// Note: getRoleBadgeColor() now in utils.js

// User search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('userSearchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(userSearchTimeout);
            
            if (query.length < 2) {
                document.getElementById('userSearchResults').style.display = 'none';
                return;
            }
            
            userSearchTimeout = setTimeout(() => searchUsers(query), 300);
        });
    }
});

async function searchUsers(query) {
    const resultsContainer = document.getElementById('userSearchResults');
    
    try {
        const response = await fetch(`/api/travel/users/search?q=${encodeURIComponent(query)}`, {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success && data.users && data.users.length > 0) {
            resultsContainer.innerHTML = data.users.map(user => `
                <button type="button" class="list-group-item list-group-item-action" 
                        onclick="shareWithUser('${user.email}', '${user.username}')">
                    <i class="fas fa-user"></i> ${user.username}
                    <small class="text-muted ms-2">${user.email}</small>
                </button>
            `).join('');
            resultsContainer.style.display = 'block';
        } else {
            resultsContainer.innerHTML = `
                <div class="list-group-item text-muted">
                    <i class="fas fa-search"></i> No users found
                </div>
            `;
            resultsContainer.style.display = 'block';
        }
    } catch (error) {
        console.error('Error searching users:', error);
    }
}

async function shareWithUser(email, username) {
    const role = document.getElementById('defaultRole').value;
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/shares`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ email, role })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Trip shared with ${username}`, 'success');
            document.getElementById('userSearchInput').value = '';
            document.getElementById('userSearchResults').style.display = 'none';
            loadShares();
        } else {
            showToast(data.error || 'Failed to share trip', 'error');
        }
    } catch (error) {
        console.error('Error sharing trip:', error);
        showToast('Failed to share trip', 'error');
    }
}

function editPermissions(shareId, email, permissions) {
    if (!permissionModal) {
        permissionModal = new bootstrap.Modal(document.getElementById('permissionModal'));
    }
    
    document.getElementById('editShareId').value = shareId;
    document.getElementById('editUserEmail').textContent = email;
    
    // Reset all checkboxes
    document.querySelectorAll('#permissionsTable input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    // Set current permissions
    if (permissions && Array.isArray(permissions)) {
        permissions.forEach(perm => {
            if (perm.category) {
                const readCb = document.querySelector(`input[data-category="${perm.category}"][data-type="read"]`);
                const writeCb = document.querySelector(`input[data-category="${perm.category}"][data-type="write"]`);
                const deleteCb = document.querySelector(`input[data-category="${perm.category}"][data-type="delete"]`);
                
                if (readCb) readCb.checked = perm.can_read || false;
                if (writeCb) writeCb.checked = perm.can_write || false;
                if (deleteCb) deleteCb.checked = perm.can_delete || false;
            }
        });
    }
    
    // Add permission hierarchy enforcement
    document.querySelectorAll('#permissionsTable input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', enforcePermissionHierarchy);
    });
    
    permissionModal.show();
}

function enforcePermissionHierarchy(event) {
    const checkbox = event.target;
    const category = checkbox.dataset.category;
    const type = checkbox.dataset.type;
    
    const readCb = document.querySelector(`input[data-category="${category}"][data-type="read"]`);
    const writeCb = document.querySelector(`input[data-category="${category}"][data-type="write"]`);
    const deleteCb = document.querySelector(`input[data-category="${category}"][data-type="delete"]`);
    
    // If write is checked, read must be checked
    if (type === 'write' && checkbox.checked && readCb) {
        readCb.checked = true;
    }
    
    // If delete is checked, write and read must be checked
    if (type === 'delete' && checkbox.checked) {
        if (writeCb) writeCb.checked = true;
        if (readCb) readCb.checked = true;
    }
    
    // If read is unchecked, write and delete must be unchecked
    if (type === 'read' && !checkbox.checked) {
        if (writeCb) writeCb.checked = false;
        if (deleteCb) deleteCb.checked = false;
    }
    
    // If write is unchecked, delete must be unchecked
    if (type === 'write' && !checkbox.checked && deleteCb) {
        deleteCb.checked = false;
    }
}

async function savePermissions() {
    const shareId = document.getElementById('editShareId').value;
    const permissions = [];
    
    // Collect all permissions
    const categories = ['budget', 'accommodations', 'activities', 'packing_list', 'timeline', 'routes', 'documents'];
    
    categories.forEach(category => {
        const readCb = document.querySelector(`input[data-category="${category}"][data-type="read"]`);
        const writeCb = document.querySelector(`input[data-category="${category}"][data-type="write"]`);
        const deleteCb = document.querySelector(`input[data-category="${category}"][data-type="delete"]`);
        
        permissions.push({
            category: category,
            can_read: readCb ? readCb.checked : false,
            can_write: writeCb ? writeCb.checked : false,
            can_delete: deleteCb ? deleteCb.checked : false
        });
    });
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/shares/${shareId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ permissions })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Permissions updated successfully', 'success');
            permissionModal.hide();
            loadShares();
        } else {
            showToast(data.error || 'Failed to update permissions', 'error');
        }
    } catch (error) {
        console.error('Error saving permissions:', error);
        showToast('Failed to update permissions', 'error');
    }
}

async function revokeAccess(shareId, username) {
    if (!confirm(`Are you sure you want to revoke ${username}'s access to this trip?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/travel/trips/${tripId}/shares/${shareId}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(`Access revoked for ${username}`, 'success');
            loadShares();
        } else {
            showToast(data.error || 'Failed to revoke access', 'error');
        }
    } catch (error) {
        console.error('Error revoking access:', error);
        showToast('Failed to revoke access', 'error');
    }
}

// ===== CALENDAR TAB FUNCTIONS =====

let calendarWeekStart = new Date();
let calendarEvents = [];
let draggedEvent = null;
let dragStartY = 0;
let currentDropZone = null;

// Initialize to start of week (Sunday)
function getWeekStart(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day;
    return new Date(d.setDate(diff));
}

// Load calendar when tab is shown
// Calendar is now auto-initialized by calendar.js when the module loads
// No need for tab click handler - Calendar.init() is called in init.js

function calendarToday() {
    if (Calendar) Calendar.goToday();
}

function calendarTomorrow() {
    if (Calendar) Calendar.goTomorrow();
}

function calendarPrevWeek() {
    if (Calendar) Calendar.prevWeek();
}

function calendarNextWeek() {
    if (Calendar) Calendar.nextWeek();
}

// Old loadCalendar() function removed - now handled by calendar.js module

function updateWeekHeader() {
    const weekEnd = new Date(calendarWeekStart);
    weekEnd.setDate(calendarWeekStart.getDate() + 6);
    
    const options = { month: 'long', day: 'numeric', year: 'numeric' };
    const rangeText = `${calendarWeekStart.toLocaleDateString(undefined, options)} - ${weekEnd.toLocaleDateString(undefined, options)}`;
    
    document.getElementById('calendarWeekRange').textContent = rangeText;
    
    // Show trip info
    const tripStartStr = '{{ trip.start_date }}';
    const tripEndStr = '{{ trip.end_date }}';
    if (tripStartStr && tripEndStr) {
        const tripStart = new Date(tripStartStr.split('T')[0]);
        const tripEnd = new Date(tripEndStr.split('T')[0]);
        document.getElementById('calendarTripInfo').textContent = 
            `Trip: ${tripStart.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} - ${tripEnd.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
    }
}

</script>
{% endblock %}
