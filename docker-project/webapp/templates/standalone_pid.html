<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surface Treatment Plant P&ID Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .plant-container {
            width: 100%;
            min-width: 2200px; /* Increased width for 20 tanks */
            height: 90vh;
            background: 
                linear-gradient(135deg, rgba(0,0,0,0.1) 0%, transparent 50%),
                repeating-linear-gradient(45deg, transparent, transparent 2px, rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 4px),
                linear-gradient(135deg, #34495e 0%, #2c3e50 25%, #1a252f 50%, #151f2a 75%, #0d1419 100%);
            position: relative;
            overflow-x: auto;
            overflow-y: hidden;
            border: 4px solid #0f1b23;
            border-radius: 12px;
            box-shadow: 
                0 12px 40px rgba(0,0,0,0.3),
                0 6px 20px rgba(0,0,0,0.2),
                0 0 0 1px rgba(255,255,255,0.05) inset,
                0 1px 3px rgba(255,255,255,0.1) inset;
        }
        
        .plant-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 800px 400px at 30% 20%, rgba(52,152,219,0.1) 0%, transparent 50%),
                radial-gradient(ellipse 600px 300px at 70% 80%, rgba(231,76,60,0.08) 0%, transparent 50%),
                linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.1) 100%);
            pointer-events: none;
            z-index: 1;
        }
        
        .plant-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: 
                repeating-linear-gradient(90deg, 
                    rgba(255,255,255,0.02) 0px, 
                    rgba(255,255,255,0.02) 1px, 
                    transparent 1px, 
                    transparent 20px),
                linear-gradient(0deg, 
                    rgba(0,0,0,0.3) 0%, 
                    rgba(0,0,0,0.1) 40%, 
                    transparent 100%);
            pointer-events: none;
            z-index: 1;
        }

        /* Tank Styles */
        .tank {
            width: 80px;
            height: 120px;
            background: linear-gradient(135deg, 
                #f5f5f5 0%, 
                #e8e8e8 15%, 
                #d8d8d8 35%, 
                #c0c0c0 50%, 
                #b8b8b8 65%, 
                #a8a8a8 85%, 
                #9a9a9a 100%);
            border: 3px solid #808080;
            border-radius: 12px 12px 8px 8px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #333;
            box-shadow: 
                0 0 0 1px rgba(255,255,255,0.3) inset,
                2px 4px 12px rgba(0,0,0,0.4),
                0 2px 4px rgba(0,0,0,0.2) inset;
            z-index: 3;
        }
        }
        
        .tank::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #d0d0d0, #a0a0a0);
            border: 2px solid #777;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4) inset;
            z-index: 1;
        }
        
        .tank::after {
            content: '';
            position: absolute;
            top: 30px;
            right: -8px;
            width: 8px;
            height: 20px;
            background: linear-gradient(90deg, #999, #bbb);
            border: 1px solid #666;
            border-radius: 0 4px 4px 0;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .tank-liquid {
            position: absolute;
            bottom: 3px;
            left: 3px;
            right: 3px;
            border-radius: 5px 5px 12px 12px;
            transition: all 2s ease-in-out;
            opacity: 0.8;
        }

        .tank-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: #2c3e50;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .tank-temp {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #e67e22;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
        }

                .tank-level {
            position: absolute;
            bottom: 8px;
            left: 8px;
            right: 8px;
            background: linear-gradient(0deg, 
                rgba(65, 105, 225, 0.9) 0%, 
                rgba(100, 149, 237, 0.8) 50%, 
                rgba(173, 216, 230, 0.7) 100%);
            border-radius: 4px;
            transition: all 0.8s ease-in-out;
            border: 1px solid rgba(0,0,0,0.2);
            box-shadow: 0 0 8px rgba(65, 105, 225, 0.3) inset;
            min-height: 2px;
        }
        
        .tank-level::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            height: 3px;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.4), 
                rgba(255,255,255,0.1), 
                rgba(255,255,255,0.4));
            border-radius: 2px;
        }
        
        .tank-gauge {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 12px;
            background: linear-gradient(135deg, #f0f0f0, #d0d0d0);
            border: 1px solid #888;
            border-radius: 2px;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Different tank types */
        .tank.degreasing .tank-liquid { background: linear-gradient(to top, #8e44ad, #9b59b6); }
        .tank.rinsing .tank-liquid { background: linear-gradient(to top, #3498db, #5dade2); }
        .tank.etching .tank-liquid { background: linear-gradient(to top, #f39c12, #f1c40f); }
        .tank.phosphating .tank-liquid { background: linear-gradient(to top, #27ae60, #2ecc71); }
        .tank.coating .tank-liquid { background: linear-gradient(to top, #e74c3c, #ec7063); }

        /* Product bars - Realistic metal workpieces */
        .product-bar {
            width: 60px;
            height: 16px;
            background: linear-gradient(135deg, 
                #c0c0c0 0%, 
                #a8a8a8 25%, 
                #909090 50%, 
                #808080 75%, 
                #707070 100%);
            border: 2px solid #606060;
            border-radius: 8px;
            position: absolute;
            transition: all 3s ease-in-out;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 3px 8px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.3) inset,
                0 1px 2px rgba(255,255,255,0.5) inset;
        }
        
        .product-bar::before {
            content: attr(data-product);
            font-size: 9px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
        }
        
        .product-bar::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 4px;
            right: 4px;
            height: 2px;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.6), 
                rgba(255,255,255,0.2), 
                rgba(255,255,255,0.6));
            border-radius: 1px;
        }

        .product-bar.in-treatment {
            background: linear-gradient(135deg, 
                #ffd700 0%, 
                #ffcc00 25%, 
                #e6b800 50%, 
                #cc9900 75%, 
                #b8860b 100%);
            border-color: #996b07;
            animation: treatment-glow 2s ease-in-out infinite alternate;
            box-shadow: 
                0 3px 8px rgba(0,0,0,0.4),
                0 0 12px rgba(255, 215, 0, 0.4),
                0 0 0 1px rgba(255,255,255,0.4) inset,
                0 1px 2px rgba(255,255,255,0.6) inset;
        }

        @keyframes treatment-glow {
            0% { 
                box-shadow: 
                    0 3px 8px rgba(0,0,0,0.4),
                    0 0 8px rgba(255, 215, 0, 0.3),
                    0 0 0 1px rgba(255,255,255,0.4) inset;
                filter: brightness(1);
            }
            100% { 
                box-shadow: 
                    0 3px 8px rgba(0,0,0,0.4),
                    0 0 20px rgba(255, 215, 0, 0.6),
                    0 0 0 1px rgba(255,255,255,0.4) inset;
                filter: brightness(1.1);
            }
        }

        /* Transporter crane - lift, carry, sink system */
        .transporter {
            position: absolute;
            top: 100px;
            width: 100px;
            height: 120px;
            z-index: 15;
            transition: left 2s ease-in-out;
        }

        /* All cranes now operate at same height - collision avoidance handled by dodging logic */

        .crane-beam {
            width: 100%;
            height: 12px;
            background: linear-gradient(135deg, 
                #e74c3c 0%, 
                #dc3545 25%, 
                #c82333 50%, 
                #a71e2a 75%, 
                #8b1538 100%);
            border: 2px solid #721c24;
            border-radius: 6px;
            position: relative;
            box-shadow: 
                0 3px 8px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.2) inset,
                0 2px 4px rgba(0,0,0,0.3) inset;
        }
        
        .crane-beam::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 10px;
            right: 10px;
            height: 4px;
            background: linear-gradient(90deg, #555, #777, #555);
            border: 1px solid #333;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .crane-beam::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 20px;
            right: 20px;
            height: 2px;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0.3), 
                rgba(255,255,255,0.1), 
                rgba(255,255,255,0.3));
            border-radius: 1px;
            transform: translateY(-50%);
        }

        .crane-beam.crane2 {
            background: linear-gradient(135deg, 
                #27ae60 0%, 
                #28a745 25%, 
                #218838 50%, 
                #1e7e34 75%, 
                #155724 100%);
            border-color: #0f4c1c;
        }

        .crane-beam.crane3 {
            background: linear-gradient(135deg, 
                #3498db 0%, 
                #2980b9 25%, 
                #2471a3 50%, 
                #1f618d 75%, 
                #1a5276 100%);
            border-color: #154360;
        }

        .crane-beam.crane4 {
            background: linear-gradient(135deg, 
                #9b59b6 0%, 
                #8e44ad 25%, 
                #7d3c98 50%, 
                #6c3483 75%, 
                #5b2c6f 100%);
            border-color: #4a235a;
        }

        .crane-trolley {
            width: 24px;
            height: 18px;
            background: linear-gradient(135deg, #34495e, #2c3e50, #1a252f);
            border: 2px solid #1c2833;
            border-radius: 4px;
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 
                0 2px 6px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.1) inset;
        }
        
        .crane-trolley::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 2px;
            right: 2px;
            height: 3px;
            background: linear-gradient(90deg, #666, #888, #666);
            border-radius: 2px;
            border: 1px solid #444;
        }
        
        .crane-trolley::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: radial-gradient(circle, #555, #333);
            border: 1px solid #222;
            border-radius: 50%;
        }

        .crane-hook {
            width: 6px;
            height: 40px;
            background: linear-gradient(135deg, #606060, #404040, #2c2c2c);
            border: 1px solid #1a1a1a;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: -40px;
            border-radius: 3px;
            transition: height 1s ease-in-out, bottom 1s ease-in-out;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.1) inset;
        }
        
        .crane-hook::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 15px;
            background: linear-gradient(0deg, #333, #555, #333);
            border-radius: 1px;
        }
        
        .crane-hook::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 4px;
            background: linear-gradient(135deg, #777, #444);
            border: 1px solid #222;
            border-radius: 0 0 6px 6px;
            clip-path: polygon(15% 0%, 85% 0%, 100% 100%, 0% 100%);
        }

        .crane-hook.lifting {
            height: 20px;
            bottom: -20px;
        }

        .crane-hook.lowering {
            height: 60px;
            bottom: -60px;
        }

        .crane-hook.with-product {
            animation: hook-sway 1s ease-in-out infinite alternate;
        }

        @keyframes hook-sway {
            0% { transform: translateX(-50%) rotate(-1deg); }
            100% { transform: translateX(-50%) rotate(1deg); }
        }

        /* Crane Status Indicators */
        .crane-indicator {
            position: absolute;
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border: 2px solid #1a252f;
            border-radius: 8px;
            color: #ecf0f1;
            font-size: 12px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 25;
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.1) inset;
            animation: indicator-pulse 1s ease-in-out infinite alternate;
        }

        .crane-indicator.lifting {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            border-color: #1e8449;
        }

        .crane-indicator.lowering {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border-color: #922b21;
        }

        .crane-indicator.crane1 {
            color: #e74c3c;
        }

        .crane-indicator.crane2 {
            color: #f39c12;
        }

        .crane-indicator.crane3 {
            color: #3498db;
        }

        .crane-indicator.crane4 {
            color: #9b59b6;
        }

        .crane-indicator::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
        }

        .crane-indicator.lifting::before {
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 8px solid #27ae60;
        }

        .crane-indicator.lowering::before {
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid #e74c3c;
        }

        @keyframes indicator-pulse {
            0% { 
                transform: scale(1);
                box-shadow: 0 4px 8px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1) inset;
            }
            100% { 
                transform: scale(1.05);
                box-shadow: 0 6px 12px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.2) inset;
            }
        }

        /* Haisuli (The Groke) Easter Egg - Accurate Moomin Character */
        .haisuli {
            position: absolute;
            width: 140px;
            height: 180px;
            bottom: 50px;
            left: -180px;
            z-index: 100;
            display: none;
            opacity: 0;
            animation-fill-mode: forwards;
        }

        /* Haisuli's main body - distinctive pear/dress shape */
        .haisuli::before {
            content: '';
            position: absolute;
            width: 140px;
            height: 160px;
            background: radial-gradient(ellipse at 50% 80%, #0a0a0a 0%, #1a1a1a 30%, #2a2a2a 60%, #1a1a1a 100%);
            border-radius: 70px 70px 20px 20px / 50px 50px 80px 80px;
            bottom: 0;
            left: 0;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.9),
                0 0 30px rgba(100,150,255,0.2) inset,
                0 -20px 40px rgba(0,0,0,0.8) inset;
        }

        /* Haisuli's eyes - large, round, glowing */
        .haisuli::after {
            content: '';
            position: absolute;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, #ffffff 0%, #00ccff 30%, #0066cc 70%, #003366 100%);
            border-radius: 50%;
            top: 45px;
            left: 30px;
            box-shadow: 
                0 0 20px #00ccff,
                0 0 40px #00aaff,
                50px 0 0 0 #ffffff,
                50px 0 0 0 #00ccff,
                50px 0 20px 0 #00ccff,
                50px 0 40px 0 #00aaff;
            animation: haisuli-eyes-glow 2s ease-in-out infinite alternate;
        }

        /* Add Haisuli's distinctive textured surface */
        .haisuli .texture {
            position: absolute;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(50,50,50,0.3) 0%, transparent 15%),
                radial-gradient(circle at 70% 20%, rgba(30,30,30,0.4) 0%, transparent 12%),
                radial-gradient(circle at 60% 60%, rgba(40,40,40,0.3) 0%, transparent 18%),
                radial-gradient(circle at 25% 80%, rgba(35,35,35,0.4) 0%, transparent 20%);
            border-radius: inherit;
            z-index: 1;
        }

        /* Haisuli's cold/freezing ground effect */
        .haisuli .frost-trail {
            position: absolute;
            width: 200px;
            height: 20px;
            background: 
                linear-gradient(90deg, 
                    transparent 0%, 
                    rgba(150,200,255,0.3) 20%, 
                    rgba(200,230,255,0.5) 50%, 
                    rgba(150,200,255,0.3) 80%, 
                    transparent 100%);
            bottom: -10px;
            left: -30px;
            border-radius: 50%;
            filter: blur(3px);
            animation: frost-spread 3s ease-out infinite;
        }

        /* Improved animations */
        @keyframes haisuli-run {
            0% {
                left: -180px;
                opacity: 0;
                transform: scale(0.7) rotate(-2deg);
            }
            15% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            85% {
                opacity: 1;
                transform: scale(1) rotate(2deg);
            }
            100% {
                left: calc(100vw + 50px);
                opacity: 0;
                transform: scale(0.7) rotate(-2deg);
            }
        }

        @keyframes haisuli-eyes-glow {
            0% {
                box-shadow: 
                    0 0 15px #00ccff,
                    0 0 30px #00aaff,
                    50px 0 0 0 #ffffff,
                    50px 0 0 0 #00ccff,
                    50px 0 15px 0 #00ccff,
                    50px 0 30px 0 #00aaff;
            }
            100% {
                box-shadow: 
                    0 0 25px #00ffff,
                    0 0 50px #00ddff,
                    50px 0 0 0 #ffffff,
                    50px 0 0 0 #00ffff,
                    50px 0 25px 0 #00ffff,
                    50px 0 50px 0 #00ddff;
            }
        }

        @keyframes frost-spread {
            0% {
                opacity: 0;
                transform: scaleX(0.5);
            }
            50% {
                opacity: 1;
                transform: scaleX(1.2);
            }
            100% {
                opacity: 0.3;
                transform: scaleX(1);
            }
        }

        .haisuli.running {
            display: block;
            animation: haisuli-run 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Add texture and frost elements via JavaScript */
        .haisuli.running::before {
            background: 
                radial-gradient(ellipse at 50% 80%, #0a0a0a 0%, #1a1a1a 30%, #2a2a2a 60%, #1a1a1a 100%),
                radial-gradient(circle at 30% 40%, rgba(60,60,60,0.3) 0%, transparent 25%),
                radial-gradient(circle at 75% 25%, rgba(40,40,40,0.4) 0%, transparent 20%);
        }

        /* Vasemmistoliitto Emergency Stop Flash */
        .vasemmisto-flash {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            background: rgba(220, 20, 60, 0.95);
            border: 4px solid #fff;
            border-radius: 20px;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            animation: emergency-flash 2s ease-in-out;
        }

        .vasemmisto-icon {
            width: 400px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8));
            animation: icon-pulse 0.5s ease-in-out infinite alternate;
        }

        .vasemmisto-icon svg {
            width: 100%;
            height: 100%;
        }

        @keyframes emergency-flash {
            0% { 
                opacity: 0;
                background: rgba(220, 20, 60, 0);
            }
            10% { 
                opacity: 1;
                background: rgba(220, 20, 60, 0.9);
            }
            90% { 
                opacity: 1;
                background: rgba(220, 20, 60, 0.9);
            }
            100% { 
                opacity: 0;
                background: rgba(220, 20, 60, 0);
            }
        }

        @keyframes icon-pulse {
            0% { 
                transform: scale(1);
                filter: drop-shadow(0 0 20px rgba(255,255,255,0.8));
            }
            100% { 
                transform: scale(1.1);
                filter: drop-shadow(0 0 40px rgba(255,255,255,1));
            }
        }

        /* Industrial Piping System */
        .pipe {
            position: absolute;
            background: linear-gradient(135deg, 
                #c0c0c0 0%, 
                #a8a8a8 25%, 
                #909090 50%, 
                #808080 75%, 
                #707070 100%);
            border: 2px solid #606060;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255,255,255,0.2) inset,
                0 1px 2px rgba(0,0,0,0.2) inset;
            z-index: 2;
        }
        
        .pipe-horizontal {
            height: 12px;
            border-radius: 6px;
        }
        
        .pipe-vertical {
            width: 12px;
            border-radius: 6px;
        }
        
        .pipe-joint {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #b0b0b0, #808080);
            border: 3px solid #606060;
            border-radius: 50%;
            box-shadow: 
                0 2px 6px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.3) inset;
            z-index: 3;
        }
        
        .valve {
            position: absolute;
            width: 16px;
            height: 24px;
            background: linear-gradient(135deg, #666, #444, #333);
            border: 2px solid #222;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4);
            z-index: 4;
        }
        
        .valve::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #777, #555);
            border: 1px solid #333;
            border-radius: 50%;
        }
        
        .valve::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 16px;
            background: linear-gradient(0deg, #888, #666);
            border-radius: 1px;
        }

        /* Pump styling */
        .pump {
            position: absolute;
            width: 40px;
            height: 30px;
            background: linear-gradient(135deg, #4a90e2, #357abd, #2c5f91);
            border: 3px solid #1a3a5c;
            border-radius: 8px;
            box-shadow: 
                0 3px 8px rgba(0,0,0,0.4),
                0 0 0 1px rgba(255,255,255,0.2) inset;
            z-index: 5;
        }
        
        .pump::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -8px;
            transform: translateY(-50%);
            width: 8px;
            height: 16px;
            background: linear-gradient(90deg, #666, #888);
            border: 1px solid #444;
            border-radius: 0 4px 4px 0;
        }
        
        .pump::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -8px;
            transform: translateY(-50%);
            width: 8px;
            height: 16px;
            background: linear-gradient(90deg, #888, #666);
            border: 1px solid #444;
            border-radius: 4px 0 0 4px;
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(44, 62, 80, 0.95);
            border: 2px solid #34495e;
            border-radius: 8px;
            padding: 15px;
            min-width: 250px;
            color: white;
            backdrop-filter: blur(5px);
        }

        .control-section {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #34495e;
        }

        .control-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s;
        }

        .control-button.start {
            background: #27ae60;
            color: white;
        }

        .control-button.stop {
            background: #e74c3c;
            color: white;
        }

        .control-button.emergency {
            background: #c0392b;
            color: white;
            font-size: 14px;
            padding: 10px;
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* Status Panel */
        .status-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(44, 62, 80, 0.95);
            color: white;
            border-radius: 8px;
            padding: 15px;
            min-width: 300px;
            backdrop-filter: blur(5px);
            border: 2px solid #34495e;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            font-size: 12px;
        }

        .status-value {
            font-weight: bold;
            color: #3498db;
        }

        .status-value.warning {
            color: #f39c12;
        }

        .status-value.error {
            color: #e74c3c;
        }

        .status-value.ok {
            color: #27ae60;
        }

        /* Process indicators */
        .process-step {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #34495e;
            border: 3px solid #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .process-step.active {
            background: #27ae60;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 10px rgba(39, 174, 96, 0.5); }
            50% { transform: scale(1.1); box-shadow: 0 0 20px rgba(39, 174, 96, 0.8); }
        }

        /* Production metrics */
        .metrics-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(44, 62, 80, 0.95);
            color: white;
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            backdrop-filter: blur(5px);
            border: 2px solid #34495e;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .metric-value {
            font-weight: bold;
            color: #f39c12;
        }
    </style>
</head>
<body>
    <h1 style="color: #2c3e50; text-align: center; margin-bottom: 20px;">üè≠ Automated Surface Treatment Plant</h1>
    
    <div class="plant-container" id="plant-container">
        <!-- Tank Layout: Single straight line of 10 tanks -->
        
        <!-- Tanks 1-10 in a straight line -->
        <div class="tank degreasing" id="tank1" style="left: 100px; top: 300px;">
            <div class="tank-liquid" id="liquid1" style="height: 70%;"></div>
            <div class="tank-label">DEGREASING</div>
            <div class="tank-temp">65¬∞C</div>
            <div class="tank-level" id="level1">1.40m</div>
        </div>

        <div class="tank rinsing" id="tank2" style="left: 200px; top: 300px;">
            <div class="tank-liquid" id="liquid2" style="height: 80%;"></div>
            <div class="tank-label">RINSE 1</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level2">1.60m</div>
        </div>

        <div class="tank etching" id="tank3" style="left: 300px; top: 300px;">
            <div class="tank-liquid" id="liquid3" style="height: 75%;"></div>
            <div class="tank-label">ETCHING</div>
            <div class="tank-temp">45¬∞C</div>
            <div class="tank-level" id="level3">1.50m</div>
        </div>

        <div class="tank rinsing" id="tank4" style="left: 400px; top: 300px;">
            <div class="tank-liquid" id="liquid4" style="height: 80%;"></div>
            <div class="tank-label">RINSE 2</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level4">1.60m</div>
        </div>

        <div class="tank phosphating" id="tank5" style="left: 500px; top: 300px;">
            <div class="tank-liquid" id="liquid5" style="height: 85%;"></div>
            <div class="tank-label">PHOSPHATING</div>
            <div class="tank-temp">55¬∞C</div>
            <div class="tank-level" id="level5">1.70m</div>
        </div>

        <div class="tank rinsing" id="tank6" style="left: 600px; top: 300px;">
            <div class="tank-liquid" id="liquid6" style="height: 80%;"></div>
            <div class="tank-label">RINSE 3</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level6">1.60m</div>
        </div>

        <div class="tank coating" id="tank7" style="left: 700px; top: 300px;">
            <div class="tank-liquid" id="liquid7" style="height: 90%;"></div>
            <div class="tank-label">E-COATING</div>
            <div class="tank-temp">30¬∞C</div>
            <div class="tank-level" id="level7">1.80m</div>
        </div>

        <div class="tank rinsing" id="tank8" style="left: 800px; top: 300px;">
            <div class="tank-liquid" id="liquid8" style="height: 80%;"></div>
            <div class="tank-label">RINSE 4</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level8">1.60m</div>
        </div>

        <div class="tank rinsing" id="tank9" style="left: 900px; top: 300px;">
            <div class="tank-liquid" id="liquid9" style="height: 80%;"></div>
            <div class="tank-label">RINSE 5</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level9">1.60m</div>
        </div>

        <div class="tank coating" id="tank10" style="left: 1000px; top: 300px;">
            <div class="tank-liquid" id="liquid10" style="height: 85%;"></div>
            <div class="tank-label">DRYING</div>
            <div class="tank-temp">80¬∞C</div>
            <div class="tank-level" id="level10">1.70m</div>
        </div>

        <div class="tank coating" id="tank11" style="left: 1100px; top: 300px;">
            <div class="tank-liquid" id="liquid11" style="height: 85%;"></div>
            <div class="tank-label">PRIMER</div>
            <div class="tank-temp">35¬∞C</div>
            <div class="tank-level" id="level11">1.60m</div>
        </div>

        <div class="tank rinsing" id="tank12" style="left: 1200px; top: 300px;">
            <div class="tank-liquid" id="liquid12" style="height: 80%;"></div>
            <div class="tank-label">RINSE 6</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level12">1.50m</div>
        </div>

        <div class="tank coating" id="tank13" style="left: 1300px; top: 300px;">
            <div class="tank-liquid" id="liquid13" style="height: 90%;"></div>
            <div class="tank-label">TOPCOAT</div>
            <div class="tank-temp">40¬∞C</div>
            <div class="tank-level" id="level13">1.80m</div>
        </div>

        <div class="tank rinsing" id="tank14" style="left: 1400px; top: 300px;">
            <div class="tank-liquid" id="liquid14" style="height: 80%;"></div>
            <div class="tank-label">RINSE 7</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level14">1.60m</div>
        </div>

        <div class="tank coating" id="tank15" style="left: 1500px; top: 300px;">
            <div class="tank-liquid" id="liquid15" style="height: 85%;"></div>
            <div class="tank-label">CURING</div>
            <div class="tank-temp">120¬∞C</div>
            <div class="tank-level" id="level15">1.70m</div>
        </div>

        <div class="tank rinsing" id="tank16" style="left: 1600px; top: 300px;">
            <div class="tank-liquid" id="liquid16" style="height: 80%;"></div>
            <div class="tank-label">RINSE 8</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level16">1.60m</div>
        </div>

        <div class="tank coating" id="tank17" style="left: 1700px; top: 300px;">
            <div class="tank-liquid" id="liquid17" style="height: 85%;"></div>
            <div class="tank-label">SEALANT</div>
            <div class="tank-temp">50¬∞C</div>
            <div class="tank-level" id="level17">1.65m</div>
        </div>

        <div class="tank coating" id="tank18" style="left: 1800px; top: 300px;">
            <div class="tank-liquid" id="liquid18" style="height: 90%;"></div>
            <div class="tank-label">FINAL CURE</div>
            <div class="tank-temp">150¬∞C</div>
            <div class="tank-level" id="level18">1.75m</div>
        </div>

        <div class="tank rinsing" id="tank19" style="left: 1900px; top: 300px;">
            <div class="tank-liquid" id="liquid19" style="height: 80%;"></div>
            <div class="tank-label">FINAL RINSE</div>
            <div class="tank-temp">25¬∞C</div>
            <div class="tank-level" id="level19">1.60m</div>
        </div>

        <div class="tank coating" id="tank20" style="left: 2000px; top: 300px;">
            <div class="tank-liquid" id="liquid20" style="height: 85%;"></div>
            <div class="tank-label">FINISH</div>
            <div class="tank-temp">60¬∞C</div>
            <div class="tank-level" id="level20">1.70m</div>
        </div>

        <!-- Crane Status Indicators -->
        <div class="crane-indicator crane1" id="indicator1" style="left: 110px; top: 260px;">C1</div>
        <div class="crane-indicator crane1" id="indicator2" style="left: 210px; top: 260px;">C1</div>
        <div class="crane-indicator crane1" id="indicator3" style="left: 310px; top: 260px;">C1</div>
        <div class="crane-indicator crane1" id="indicator4" style="left: 410px; top: 260px;">C1</div>
        <div class="crane-indicator crane1" id="indicator5" style="left: 510px; top: 260px;">C1</div>
        <div class="crane-indicator crane2" id="indicator6" style="left: 610px; top: 260px;">C2</div>
        <div class="crane-indicator crane2" id="indicator7" style="left: 710px; top: 260px;">C2</div>
        <div class="crane-indicator crane2" id="indicator8" style="left: 810px; top: 260px;">C2</div>
        <div class="crane-indicator crane2" id="indicator9" style="left: 910px; top: 260px;">C2</div>
        <div class="crane-indicator crane2" id="indicator10" style="left: 1010px; top: 260px;">C2</div>
        <div class="crane-indicator crane3" id="indicator11" style="left: 1110px; top: 260px;">C3</div>
        <div class="crane-indicator crane3" id="indicator12" style="left: 1210px; top: 260px;">C3</div>
        <div class="crane-indicator crane3" id="indicator13" style="left: 1310px; top: 260px;">C3</div>
        <div class="crane-indicator crane3" id="indicator14" style="left: 1410px; top: 260px;">C3</div>
        <div class="crane-indicator crane3" id="indicator15" style="left: 1510px; top: 260px;">C3</div>
        <div class="crane-indicator crane4" id="indicator16" style="left: 1610px; top: 260px;">C4</div>
        <div class="crane-indicator crane4" id="indicator17" style="left: 1710px; top: 260px;">C4</div>
        <div class="crane-indicator crane4" id="indicator18" style="left: 1810px; top: 260px;">C4</div>
        <div class="crane-indicator crane4" id="indicator19" style="left: 1910px; top: 260px;">C4</div>
        <div class="crane-indicator crane4" id="indicator20" style="left: 2010px; top: 260px;">C4</div>

        <!-- Transporter Cranes -->
        <div class="transporter" id="transporter1" style="left: 100px;">
            <div class="crane-beam">
                <div class="crane-trolley"></div>
                <div class="crane-hook" id="crane-hook1"></div>
            </div>
        </div>

        <div class="transporter crane2" id="transporter2" style="left: 600px;">
            <div class="crane-beam crane2">
                <div class="crane-trolley"></div>
                <div class="crane-hook" id="crane-hook2"></div>
            </div>
        </div>

        <div class="transporter crane3" id="transporter3" style="left: 1000px;">
            <div class="crane-beam crane3">
                <div class="crane-trolley"></div>
                <div class="crane-hook" id="crane-hook3"></div>
            </div>
        </div>

        <div class="transporter crane4" id="transporter4" style="left: 1500px;">
            <div class="crane-beam crane4">
                <div class="crane-trolley"></div>
                <div class="crane-hook" id="crane-hook4"></div>
            </div>
        </div>

        <!-- Product Bars -->
        <div class="product-bar" id="product1" data-product="P1" style="left: 50px; top: 250px;"></div>
        <div class="product-bar" id="product2" data-product="P2" style="left: 1100px; top: 250px;"></div>
        <div class="product-bar" id="product3" data-product="P3" style="left: 1200px; top: 250px;"></div>

        <!-- Process Step Indicators - moved to bottom -->
        <div class="process-step active" style="left: 130px; top: 450px;">1</div>
        <div class="process-step" style="left: 230px; top: 450px;">2</div>
        <div class="process-step" style="left: 330px; top: 450px;">3</div>
        <div class="process-step" style="left: 430px; top: 450px;">4</div>
        <div class="process-step" style="left: 530px; top: 450px;">5</div>
        <div class="process-step" style="left: 630px; top: 450px;">6</div>
        <div class="process-step" style="left: 730px; top: 450px;">7</div>
        <div class="process-step" style="left: 830px; top: 450px;">8</div>
        <div class="process-step" style="left: 930px; top: 450px;">9</div>
        <div class="process-step" style="left: 1030px; top: 450px;">10</div>
        <div class="process-step" style="left: 1130px; top: 450px;">11</div>
        <div class="process-step" style="left: 1230px; top: 450px;">12</div>
        <div class="process-step" style="left: 1330px; top: 450px;">13</div>
        <div class="process-step" style="left: 1430px; top: 450px;">14</div>
        <div class="process-step" style="left: 1530px; top: 450px;">15</div>
        <div class="process-step" style="left: 1630px; top: 450px;">16</div>
        <div class="process-step" style="left: 1730px; top: 450px;">17</div>
        <div class="process-step" style="left: 1830px; top: 450px;">18</div>
        <div class="process-step" style="left: 1930px; top: 450px;">19</div>
        <div class="process-step" style="left: 2030px; top: 450px;">20</div>

        <!-- Production Metrics -->
        <div class="metrics-display">
            <h4 style="margin: 0 0 10px 0; color: #f39c12;">üìä Production Metrics</h4>
            <div class="metric-item">
                <span>Products Processed:</span>
                <span class="metric-value" id="products-processed">47</span>
            </div>
            <div class="metric-item">
                <span>Cycle Time:</span>
                <span class="metric-value" id="cycle-time">12.5 min</span>
            </div>
            <div class="metric-item">
                <span>Efficiency:</span>
                <span class="metric-value" id="efficiency">94.2%</span>
            </div>
            <div class="metric-item">
                <span>Active Products:</span>
                <span class="metric-value" id="active-products">3</span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <h4 style="margin: 0 0 10px 0;">üéÆ Plant Control</h4>
            
            <div class="control-section">
                <h6 style="margin: 5px 0; color: #bdc3c7;">Production Control</h6>
                <button class="control-button start" onclick="startProduction()">‚ñ∂Ô∏è Start Production</button>
                <button class="control-button stop" onclick="stopProduction()">‚èπÔ∏è Stop Production</button>
                <button class="control-button" onclick="loadNewProduct()" style="background: #3498db; color: white;">‚ûï Load Product</button>
            </div>

            <div class="control-section">
                <h6 style="margin: 5px 0; color: #bdc3c7;">Process Control</h6>
                <button class="control-button" onclick="startManualProcess()" style="background: #27ae60; color: white;">üöÄ Start Process</button>
                <button class="control-button" onclick="skipToNext()" style="background: #f39c12; color: white;">‚è© Skip to Next</button>
                <button class="control-button" onclick="autoDemo()" style="background: #9b59b6; color: white;">ü§ñ Auto Demo</button>
                <button class="control-button" onclick="refillTanks()" style="background: #3498db; color: white;">üíß Refill Tanks</button>
            </div>

            <div class="control-section">
                <button class="control-button emergency" onclick="emergencyStop()">üö® EMERGENCY STOP</button>
            </div>
        </div>

        <!-- Haisuli Easter Egg -->
        <div class="haisuli" id="haisuli"></div>

        <!-- Vasemmistoliitto Emergency Flash -->
        <div class="vasemmisto-flash" id="vasemmisto-flash">
            <div class="vasemmisto-icon">
                <!-- Embedded SVG for Vasemmistoliitto-style logo -->
                <svg width="400" height="400" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                    <!-- Red background circle -->
                    <circle cx="50" cy="50" r="45" fill="#DC143C" stroke="#fff" stroke-width="2"/>
                    <!-- White star -->
                    <polygon points="50,20 56,38 75,38 61,50 67,68 50,56 33,68 39,50 25,38 44,38" fill="#fff"/>
                    <!-- Text "VAS" -->
                    <text x="50" y="85" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#fff" text-anchor="middle">VAS</text>
                </svg>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <h4 style="margin: 0 0 10px 0;">üìã System Status</h4>
            <div class="status-item">
                <span>Production Status:</span>
                <span class="status-value ok" id="production-status">RUNNING</span>
            </div>
            <div class="status-item">
                <span>Transporter 1:</span>
                <span class="status-value ok" id="transporter1-status">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>Transporter 2:</span>
                <span class="status-value ok" id="transporter2-status">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>Transporter 3:</span>
                <span class="status-value ok" id="transporter3-status">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>Transporter 4:</span>
                <span class="status-value ok" id="transporter4-status">ACTIVE</span>
            </div>
            <div class="status-item">
                <span>Current Station 1:</span>
                <span class="status-value" id="current-station1">Station 1</span>
            </div>
            <div class="status-item">
                <span>Current Station 2:</span>
                <span class="status-value" id="current-station2">Station 6</span>
            </div>
            <div class="status-item">
                <span>Current Station 3:</span>
                <span class="status-value" id="current-station3">Station 10</span>
            </div>
            <div class="status-item">
                <span>Current Station 4:</span>
                <span class="status-value" id="current-station4">Station 15</span>
            </div>
            <div class="status-item">
                <span>Tank Temperatures:</span>
                <span class="status-value ok" id="temp-status">NOMINAL</span>
            </div>
            <div class="status-item">
                <span>Chemical Levels:</span>
                <span class="status-value ok" id="chemical-status">ADEQUATE</span>
            </div>
            <div class="status-item">
                <span>Tank Levels:</span>
                <span class="status-value ok" id="tank-levels-status">NORMAL</span>
            </div>
            <div class="status-item">
                <span>System Pressure:</span>
                <span class="status-value ok" id="pressure-status">2.4 BAR</span>
            </div>
            <div class="status-item">
                <span>Conveyor Speed:</span>
                <span class="status-value" id="conveyor-speed">1.2 m/min</span>
            </div>
            <div class="status-item">
                <span>Next Maintenance:</span>
                <span class="status-value warning" id="maintenance">72 hours</span>
            </div>
        </div>
    </div>

    <script>
        // Production state
        let productionState = {
            isRunning: false,
            currentStation: 1,
            productsInSystem: 3,
            processedCount: 47,
            cycleTime: 12.5,
            efficiency: 94.2
        };

        let transporter1 = {
            position: 1,
            isMoving: false,
            hasProduct: false,
            currentProduct: null,
            operatingRange: [1, 2, 3, 4, 5, 6] // Stations 1-6
        };

        let transporter2 = {
            position: 6,
            isMoving: false,
            hasProduct: false,
            currentProduct: null,
            operatingRange: [6, 7, 8, 9, 10] // Stations 6-10
        };

        let transporter3 = {
            position: 10,
            isMoving: false,
            hasProduct: false,
            currentProduct: null,
            operatingRange: [10, 11, 12, 13, 14, 15] // Stations 10-15
        };

        let transporter4 = {
            position: 15,
            isMoving: false,
            hasProduct: false,
            currentProduct: null,
            operatingRange: [15, 16, 17, 18, 19, 20] // Stations 15-20
        };

        let products = [
            { id: 'product1', station: 0, element: null, processed: false },
            { id: 'product2', station: 0, element: null, processed: false },
            { id: 'product3', station: 0, element: null, processed: false }
        ];

        let demoMode = false;
        let demoInterval;
        let levelAnimationInterval;

        // Tank level data
        let tankLevels = [
            { id: 1, currentLevel: 1.40, targetLevel: 1.40, minLevel: 1.20, maxLevel: 1.80 },
            { id: 2, currentLevel: 1.60, targetLevel: 1.60, minLevel: 1.40, maxLevel: 1.90 },
            { id: 3, currentLevel: 1.50, targetLevel: 1.50, minLevel: 1.30, maxLevel: 1.85 },
            { id: 4, currentLevel: 1.60, targetLevel: 1.60, minLevel: 1.40, maxLevel: 1.90 },
            { id: 5, currentLevel: 1.70, targetLevel: 1.70, minLevel: 1.50, maxLevel: 2.00 },
            { id: 6, currentLevel: 1.60, targetLevel: 1.60, minLevel: 1.40, maxLevel: 1.90 },
            { id: 7, currentLevel: 1.80, targetLevel: 1.80, minLevel: 1.60, maxLevel: 2.00 },
            { id: 8, currentLevel: 1.60, targetLevel: 1.60, minLevel: 1.40, maxLevel: 1.90 },
            { id: 9, currentLevel: 1.60, targetLevel: 1.60, minLevel: 1.40, maxLevel: 1.90 },
            { id: 10, currentLevel: 1.70, targetLevel: 1.70, minLevel: 1.50, maxLevel: 2.00 }
        ];

        // Tank positions for transporter movement (straight line)
        const tankPositions = [
            { x: 100, y: 300, station: 1 },    // Tank 1
            { x: 200, y: 300, station: 2 },    // Tank 2
            { x: 300, y: 300, station: 3 },    // Tank 3
            { x: 400, y: 300, station: 4 },    // Tank 4
            { x: 500, y: 300, station: 5 },    // Tank 5
            { x: 600, y: 300, station: 6 },    // Tank 6
            { x: 700, y: 300, station: 7 },    // Tank 7
            { x: 800, y: 300, station: 8 },    // Tank 8
            { x: 900, y: 300, station: 9 },    // Tank 9
            { x: 1000, y: 300, station: 10 },  // Tank 10
            { x: 1100, y: 300, station: 11 },  // Tank 11
            { x: 1200, y: 300, station: 12 },  // Tank 12
            { x: 1300, y: 300, station: 13 },  // Tank 13
            { x: 1400, y: 300, station: 14 },  // Tank 14
            { x: 1500, y: 300, station: 15 },  // Tank 15
            { x: 1600, y: 300, station: 16 },  // Tank 16
            { x: 1700, y: 300, station: 17 },  // Tank 17
            { x: 1800, y: 300, station: 18 },  // Tank 18
            { x: 1900, y: 300, station: 19 },  // Tank 19
            { x: 2000, y: 300, station: 20 }   // Tank 20
        ];

        // Initialize
        function init() {
            // Set up product elements
            products.forEach((product, index) => {
                product.element = document.getElementById(product.id);
            });
            
            // Initialize crane positions to avoid initial collisions
            initializeCranePositions();
            
            updateDisplay();
            startRandomVariations();
            startTankLevelAnimations();
        }

        // Initialize cranes at safe starting positions
        function initializeCranePositions() {
            const crane1Element = document.getElementById('transporter1');
            const crane2Element = document.getElementById('transporter2');
            const crane3Element = document.getElementById('transporter3');
            const crane4Element = document.getElementById('transporter4');
            
            // Position cranes at their starting stations with safe spacing
            const station1Pos = tankPositions.find(pos => pos.station === 1);
            const station6Pos = tankPositions.find(pos => pos.station === 6);
            const station10Pos = tankPositions.find(pos => pos.station === 10);
            const station15Pos = tankPositions.find(pos => pos.station === 15);
            
            if (crane1Element && station1Pos) {
                crane1Element.style.left = station1Pos.x + 'px';
            }
            if (crane2Element && station6Pos) {
                crane2Element.style.left = station6Pos.x + 'px';
            }
            if (crane3Element && station10Pos) {
                crane3Element.style.left = station10Pos.x + 'px';
            }
            if (crane4Element && station15Pos) {
                crane4Element.style.left = station15Pos.x + 'px';
            }
            
            console.log('Cranes initialized at safe starting positions');
        }

        // Tank level animations
        function startTankLevelAnimations() {
            levelAnimationInterval = setInterval(() => {
                tankLevels.forEach(tank => {
                    // Simulate level changes due to processing
                    if (Math.random() < 0.3) { // 30% chance of level change
                        const variation = (Math.random() - 0.5) * 0.10; // ¬±5cm variation
                        tank.targetLevel = Math.max(tank.minLevel, Math.min(tank.maxLevel, tank.currentLevel + variation));
                    }
                    
                    // Gradually move current level towards target
                    const difference = tank.targetLevel - tank.currentLevel;
                    if (Math.abs(difference) > 0.01) {
                        tank.currentLevel += difference * 0.1; // Smooth transition
                        updateTankLevel(tank.id, tank.currentLevel);
                    }
                });
            }, 2000); // Update every 2 seconds
        }

        function updateTankLevel(tankId, level) {
            const liquidElement = document.getElementById(`liquid${tankId}`);
            const levelElement = document.getElementById(`level${tankId}`);
            
            if (liquidElement && levelElement) {
                // Calculate percentage (assuming 2m is 100% of tank height)
                const percentage = (level / 2.0) * 100;
                liquidElement.style.height = Math.max(10, Math.min(95, percentage)) + '%';
                
                // Update level display
                levelElement.textContent = level.toFixed(2) + 'm';
                
                // Change color based on level
                if (level < tankLevels[tankId - 1].minLevel + 0.1) {
                    levelElement.style.background = '#e74c3c'; // Red for low
                } else if (level > tankLevels[tankId - 1].maxLevel - 0.1) {
                    levelElement.style.background = '#f39c12'; // Orange for high
                } else {
                    levelElement.style.background = '#3498db'; // Blue for normal
                }
            }
        }

        function simulateProductImpact(stationNumber) {
            // When product enters tank, level slightly increases
            const tank = tankLevels[stationNumber - 1];
            if (tank) {
                tank.targetLevel = Math.min(tank.maxLevel, tank.currentLevel + 0.02); // +2cm when product enters
                
                // When product exits, level slightly decreases
                setTimeout(() => {
                    tank.targetLevel = Math.max(tank.minLevel, tank.currentLevel - 0.03); // -3cm when product exits (evaporation/carryout)
                }, 3000);
            }
        }

        // Production control
        function startProduction() {
            productionState.isRunning = true;
            updateStatus('production-status', 'RUNNING', 'ok');
            updateStatus('transporter-status1', 'ACTIVE', 'ok');
            updateStatus('transporter-status2', 'ACTIVE', 'ok');
            
            if (!demoMode) {
                beginProductionCycle();
                startParallelCraneMonitoring(); // Start parallel operations monitoring
            }
        }

        function stopProduction() {
            productionState.isRunning = false;
            updateStatus('production-status', 'STOPPED', 'warning');
            updateStatus('transporter-status', 'IDLE', 'warning');
        }

        function emergencyStop() {
            // Trigger Vasemmistoliitto flash
            flashVasemmistoIcon();
            
            productionState.isRunning = false;
            demoMode = false;
            if (demoInterval) clearInterval(demoInterval);
            if (levelAnimationInterval) clearInterval(levelAnimationInterval);
            
            updateStatus('production-status', 'EMERGENCY STOP', 'error');
            updateStatus('transporter-status', 'LOCKED', 'error');
            updateStatus('tank-levels-status', 'MONITORING STOPPED', 'error');
        }

        // Product management
        function loadNewProduct() {
            // Trigger Haisuli Easter Egg
            runHaisuli();
            
            const newProductId = 'product' + (Date.now() % 1000);
            const productBar = document.createElement('div');
            productBar.className = 'product-bar';
            productBar.id = newProductId;
            productBar.setAttribute('data-product', 'P' + (products.length + 1));
            productBar.style.left = '50px';
            productBar.style.top = '380px';
            // Hide products that are not yet in the production line (station 0)
            productBar.style.opacity = '0';
            productBar.style.visibility = 'hidden';
            
            document.getElementById('plant-container').appendChild(productBar);
            
            products.push({
                id: newProductId,
                station: 0,
                element: productBar,
                processed: false
            });

            productionState.productsInSystem++;
            updateDisplay();
            
            console.log(`Created new product ${newProductId} - hidden until entering production line`);
        }

        // Determine which transporter should handle a station
        function getTransporterForStation(stationNumber) {
            if (stationNumber <= 6) {
                return { transporter: transporter1, id: 1, element: 'transporter1', hook: 'crane-hook1' };
            } else if (stationNumber <= 10) {
                return { transporter: transporter2, id: 2, element: 'transporter2', hook: 'crane-hook2' };
            } else if (stationNumber <= 15) {
                return { transporter: transporter3, id: 3, element: 'transporter3', hook: 'crane-hook3' };
            } else {
                return { transporter: transporter4, id: 4, element: 'transporter4', hook: 'crane-hook4' };
            }
        }

        // Collision detection and avoidance system
        function getCranePosition(transporterId) {
            const element = document.getElementById(`transporter${transporterId}`);
            const leftValue = element ? parseInt(element.style.left) || 0 : 0;
            console.log(`Crane ${transporterId} position: ${leftValue}px`);
            return leftValue;
        }

        function isCarryingProduct(transporterId) {
            const hookElement = document.getElementById(`crane-hook${transporterId}`);
            const hasProduct = hookElement ? hookElement.classList.contains('with-product') : false;
            console.log(`Crane ${transporterId} carrying product: ${hasProduct}`);
            return hasProduct;
        }

        function checkCraneCollision(movingCraneId, targetX) {
            const minDistance = 150; // Increased from 120 for better safety margin
            const allCranes = [1, 2, 3, 4];
            
            console.log(`Checking collision for crane ${movingCraneId} moving to ${targetX}px`);
            
            for (let craneId of allCranes) {
                if (craneId === movingCraneId) continue;
                
                const otherCraneX = getCranePosition(craneId);
                const distance = Math.abs(targetX - otherCraneX);
                
                console.log(`Distance between crane ${movingCraneId} and crane ${craneId}: ${distance}px`);
                
                if (distance < minDistance) {
                    console.log(`COLLISION DETECTED! Crane ${movingCraneId} would be too close to crane ${craneId}`);
                    return {
                        collision: true,
                        conflictingCrane: craneId,
                        hasProduct: isCarryingProduct(craneId)
                    };
                }
            }
            
            console.log(`No collision detected for crane ${movingCraneId}`);
            return { collision: false };
        }

        function findSafePosition(movingCraneId, targetX) {
            const minDistance = 150; // Match the collision detection distance
            const allCranes = [1, 2, 3, 4];
            
            console.log(`Finding safe position for crane ${movingCraneId}, originally targeting ${targetX}px`);
            
            // Try positions around the target with increasing offsets
            for (let offset = 60; offset <= 400; offset += 60) {
                for (let direction of [-1, 1]) {
                    const testX = targetX + (direction * offset);
                    
                    // Check bounds (stay within plant area with some margin)
                    if (testX < 50 || testX > 2050) {
                        console.log(`Position ${testX}px is out of bounds`);
                        continue;
                    }
                    
                    let isSafe = true;
                    for (let craneId of allCranes) {
                        if (craneId === movingCraneId) continue;
                        
                        const otherCraneX = getCranePosition(craneId);
                        const distance = Math.abs(testX - otherCraneX);
                        
                        if (distance < minDistance) {
                            console.log(`Position ${testX}px too close to crane ${craneId} (distance: ${distance}px)`);
                            isSafe = false;
                            break;
                        }
                    }
                    
                    if (isSafe) {
                        console.log(`‚úÖ Found safe position: ${testX}px (offset: ${direction * offset}px)`);
                        return testX;
                    }
                }
            }
            
            console.log(`‚ö†Ô∏è No safe position found, returning original target: ${targetX}px`);
            return targetX; // Return original if no safe position found
        }

        function dodgeOtherCrane(movingCraneId, targetX, hasProduct) {
            console.log(`Dodge check: Crane ${movingCraneId} wants to move to ${targetX}px, has product: ${hasProduct}`);
            
            const collision = checkCraneCollision(movingCraneId, targetX);
            
            if (collision.collision) {
                console.log(`COLLISION! Crane ${movingCraneId} conflicts with crane ${collision.conflictingCrane}`);
                
                // If moving crane has product, it has priority
                if (hasProduct && !collision.hasProduct) {
                    // Move the other crane out of the way
                    const otherCraneElement = document.getElementById(`transporter${collision.conflictingCrane}`);
                    const currentPos = getCranePosition(collision.conflictingCrane);
                    const safePosition = findSafePosition(collision.conflictingCrane, currentPos);
                    
                    console.log(`üöõ Crane ${collision.conflictingCrane} DODGING from ${currentPos}px to ${safePosition}px for crane ${movingCraneId} with product`);
                    
                    if (otherCraneElement && safePosition !== currentPos) {
                        otherCraneElement.style.left = safePosition + 'px';
                        // Add visual indicator for dodging
                        otherCraneElement.style.transition = 'left 1s ease-out';
                        setTimeout(() => {
                            otherCraneElement.style.transition = 'left 2s ease-in-out';
                        }, 1000);
                    }
                    
                    return targetX; // Moving crane can proceed to original target
                }
                // If moving crane has no product, it should dodge
                else if (!hasProduct) {
                    const safePosition = findSafePosition(movingCraneId, targetX);
                    console.log(`üöõ Crane ${movingCraneId} DODGING to safe position ${safePosition}px (originally wanted ${targetX}px)`);
                    return safePosition;
                }
                // Both have products or both don't - first crane gets priority
                else {
                    const safePosition = findSafePosition(movingCraneId, targetX);
                    console.log(`‚ö†Ô∏è Both cranes busy - Crane ${movingCraneId} finding alternative position ${safePosition}px`);
                    return safePosition;
                }
            }
            
            console.log(`‚úÖ No collision - Crane ${movingCraneId} proceeding to ${targetX}px`);
            return targetX; // No collision
        }

        // Crane status indicator functions
        function showCraneIndicator(stationNumber, craneNumber, action) {
            const indicator = document.getElementById(`indicator${stationNumber}`);
            if (indicator) {
                indicator.textContent = `C${craneNumber}`;
                indicator.className = `crane-indicator crane${craneNumber} ${action}`;
                indicator.style.display = 'flex';
                
                console.log(`Showing indicator: Station ${stationNumber}, Crane ${craneNumber}, Action: ${action}`);
            }
        }

        function hideCraneIndicator(stationNumber) {
            const indicator = document.getElementById(`indicator${stationNumber}`);
            if (indicator) {
                indicator.style.display = 'none';
                console.log(`Hiding indicator: Station ${stationNumber}`);
            }
        }

        function hideAllCraneIndicators() {
            for (let i = 1; i <= 20; i++) {
                hideCraneIndicator(i);
            }
        }

        // Haisuli Easter Egg Function
        function runHaisuli() {
            const haisuli = document.getElementById('haisuli');
            if (haisuli) {
                // Clear any existing content
                haisuli.innerHTML = '';
                
                // Add texture layer
                const texture = document.createElement('div');
                texture.className = 'texture';
                haisuli.appendChild(texture);
                
                // Add frost trail
                const frostTrail = document.createElement('div');
                frostTrail.className = 'frost-trail';
                haisuli.appendChild(frostTrail);
                
                // Reset position and make visible
                haisuli.style.left = '-180px';
                haisuli.classList.remove('running');
                haisuli.style.display = 'block';
                
                // Small delay to ensure reset, then start animation
                setTimeout(() => {
                    haisuli.classList.add('running');
                    console.log('üåô Haisuli (The Groke) is running across the screen!');
                    
                    // Hide after animation completes
                    setTimeout(() => {
                        haisuli.style.display = 'none';
                        haisuli.classList.remove('running');
                        haisuli.innerHTML = ''; // Clean up
                        console.log('üëª Haisuli has disappeared into the cold darkness...');
                    }, 3000);
                }, 50);
            }
        }

        // Vasemmistoliitto Emergency Flash Function
        function flashVasemmistoIcon() {
            const flashOverlay = document.getElementById('vasemmisto-flash');
            if (flashOverlay) {
                // Show the flash overlay
                flashOverlay.style.display = 'flex';
                console.log('üö® EMERGENCY STOP - Vasemmistoliitto flash activated!');
                
                // Hide after 2 seconds
                setTimeout(() => {
                    flashOverlay.style.display = 'none';
                    console.log('‚úã Emergency flash completed');
                }, 2000);
            }
        }

        // Transporter movement with lift, carry, sink animation
        function moveTransporterToStation(stationNumber) {
            const transporterInfo = getTransporterForStation(stationNumber);
            const transporter = transporterInfo.transporter;
            
            if (transporter.isMoving) {
                console.log(`Transporter ${transporterInfo.id} is busy, skipping station ${stationNumber}`);
                return;
            }
            
            transporter.isMoving = true;
            const targetPosition = tankPositions.find(pos => pos.station === stationNumber);
            
            if (targetPosition) {
                const transporterElement = document.getElementById(transporterInfo.element);
                const hookElement = document.getElementById(transporterInfo.hook);
                
                // Find product that needs to be moved to this station
                let currentProduct = null;
                
                if (stationNumber === 1) {
                    // Moving to first station - find highest priority product at loading area (station 0)
                    const availableProducts = products.filter(p => p.station === 0);
                    if (availableProducts.length > 0) {
                        // Sort by ID to get the most recently added product (highest priority)
                        availableProducts.sort((a, b) => b.id - a.id);
                        currentProduct = availableProducts[0];
                        console.log(`üéØ Selected highest priority product ${currentProduct.id} from ${availableProducts.length} available at station 0`);
                    }
                } else {
                    // Moving to subsequent stations - find highest priority product at previous station
                    const availableProducts = products.filter(p => p.station === stationNumber - 1);
                    if (availableProducts.length > 0) {
                        // Sort by station number and then by ID for priority (highest tank number first)
                        availableProducts.sort((a, b) => {
                            if (a.station !== b.station) return b.station - a.station; // Higher station first
                            return b.id - a.id; // Then by product ID (most recent first)
                        });
                        currentProduct = availableProducts[0];
                        console.log(`üéØ Selected highest priority product ${currentProduct.id} from ${availableProducts.length} available at station ${stationNumber - 1}`);
                    }
                }
                
                console.log(`Transporter ${transporterInfo.id} moving to station ${stationNumber}, found product:`, currentProduct);
                
                // Step 1: Move transporter to pickup location first (if not first station)
                if (stationNumber > 1 && currentProduct) {
                    const pickupPosition = tankPositions.find(pos => pos.station === stationNumber - 1);
                    if (pickupPosition && transporter.operatingRange.includes(stationNumber - 1)) {
                        // Apply collision avoidance for pickup movement
                        const safePickupX = dodgeOtherCrane(transporterInfo.id, pickupPosition.x, false);
                        transporterElement.style.left = safePickupX + 'px';
                    }
                }
                
                setTimeout(() => {
                    // Step 2: Lower hook to pick up product
                    hookElement.classList.add('lowering');
                    hookElement.classList.remove('lifting');
                    
                    // Show lowering indicator at pickup station
                    const pickupStation = stationNumber > 1 ? stationNumber - 1 : stationNumber;
                    showCraneIndicator(pickupStation, transporterInfo.id, 'lowering');
                    
                    setTimeout(() => {
                        // Step 3: Lift product
                        hookElement.classList.remove('lowering');
                        hookElement.classList.add('lifting');
                        hookElement.classList.add('with-product');
                        
                        // Show lifting indicator at pickup station
                        showCraneIndicator(pickupStation, transporterInfo.id, 'lifting');
                        
                        // Hide indicator after brief display
                        setTimeout(() => {
                            hideCraneIndicator(pickupStation);
                        }, 800);
                        
                        // Attach product to hook if available
                        if (currentProduct && currentProduct.element) {
                            // Make product visible when entering production line
                            currentProduct.element.style.opacity = '1';
                            currentProduct.element.style.visibility = 'visible';
                            
                            // Position product directly relative to current transporter position
                            const currentTransporterX = parseInt(transporterElement.style.left) || transporter.position || 100;
                            
                            // Transporter is 100px wide, hook is centered at 50% = 50px from left edge
                            // Product is 60px wide (from CSS), so we need to offset by 30px to center it under the hook
                            const transporterWidth = 100;
                            const productWidth = 60; // Actual product width from CSS
                            const hookCenterOffset = transporterWidth / 2; // 50px - center of transporter
                            const productCenterOffset = productWidth / 2; // 30px - half product width
                            const hookOffsetY = 150; // Height of lifted position
                            
                            currentProduct.element.style.transition = 'all 1s ease-in-out';
                            // Center product under crane hook: transporter left + hook center - half product width
                            currentProduct.element.style.left = (currentTransporterX + hookCenterOffset - productCenterOffset) + 'px';
                            currentProduct.element.style.top = hookOffsetY + 'px';
                            currentProduct.element.style.zIndex = '20';
                            
                            console.log(`Transporter ${transporterInfo.id} lifted product ${currentProduct.id} - positioned at ${currentTransporterX + hookCenterOffset - productCenterOffset}px (transporter: ${currentTransporterX}px, hook center: ${hookCenterOffset}px, product offset: ${productCenterOffset}px)`);
                        }
                        
                        setTimeout(() => {
                            // Step 4: Move horizontally to target station while carrying product
                            // Apply collision avoidance
                            const hasProduct = currentProduct !== null;
                            const safeTargetX = dodgeOtherCrane(transporterInfo.id, targetPosition.x, hasProduct);
                            
                            transporterElement.style.left = safeTargetX + 'px';
                            
                            // Move product with transporter - perfectly synchronized movement
                            if (currentProduct && currentProduct.element) {
                                // Ensure product moves with exact same transition as crane
                                currentProduct.element.style.transition = 'all 2s ease-in-out';
                                
                                // Keep product attached to hook center during horizontal movement
                                const transporterWidth = 100;
                                const productWidth = 60; // Actual product width from CSS
                                const hookCenterOffset = transporterWidth / 2; // 50px - center of transporter
                                const productCenterOffset = productWidth / 2; // 30px - half product width
                                
                                // Center product under crane hook: transporter left + hook center - half product width
                                currentProduct.element.style.left = (safeTargetX + hookCenterOffset - productCenterOffset) + 'px';
                                // Keep same Y position during horizontal movement
                                
                                console.log(`Product ${currentProduct.id} moving with transporter to ${safeTargetX + hookCenterOffset - productCenterOffset}px`);
                            }
                            
                            transporter.position = stationNumber;
                            updateStatus(`current-station${transporterInfo.id}`, `Station ${stationNumber}`);
                            
                            // Update active process step
                            document.querySelectorAll('.process-step').forEach(step => {
                                step.classList.remove('active');
                            });
                            const activeStep = document.querySelectorAll('.process-step')[stationNumber - 1];
                            if (activeStep) {
                                activeStep.classList.add('active');
                            }
                            
                            setTimeout(() => {
                                // Step 5: Lower product into tank
                                hookElement.classList.remove('lifting');
                                hookElement.classList.add('lowering');
                                
                                // Show lowering indicator at delivery station
                                showCraneIndicator(stationNumber, transporterInfo.id, 'lowering');
                                
                                setTimeout(() => {
                                    // Step 6: Release product and lift hook back up
                                    hookElement.classList.remove('lowering', 'with-product');
                                    hookElement.classList.add('lifting');
                                    
                                    // Show lifting indicator at delivery station
                                    showCraneIndicator(stationNumber, transporterInfo.id, 'lifting');
                                    
                                    // Hide indicator after brief display
                                    setTimeout(() => {
                                        hideCraneIndicator(stationNumber);
                                    }, 800);
                                    
                                    transporter.isMoving = false;
                                    
                                    console.log(`Transporter ${transporterInfo.id} delivered product to station ${stationNumber}`);
                                    processProductAtStation(stationNumber);
                                }, 1000);
                            }, 2000);
                        }, 1000);
                    }, 1000);
                }, 500);
            }
        }

        function processProductAtStation(stationNumber) {
            // Find product at current station
            const product = products.find(p => p.station === stationNumber - 1);
            
            if (product && product.element) {
                // Simulate tank level impact when product enters
                simulateProductImpact(stationNumber);
                
                // Move product to treatment position inside tank - use tankPositions for consistency
                const tankPosition = tankPositions.find(pos => pos.station === stationNumber);
                if (tankPosition) {
                    // Position product in center of tank, accounting for product width
                    const tankWidth = 80; // Tank width in pixels
                    const productWidth = 60; // Actual product width from CSS
                    const centerOffset = (tankWidth - productWidth) / 2; // Offset to center product in tank
                    
                    // Disable transition temporarily to prevent unwanted animation
                    product.element.style.transition = 'none';
                    
                    product.element.style.left = (tankPosition.x + centerOffset) + 'px'; // Center of tank
                    product.element.style.top = (tankPosition.y + 50) + 'px'; // Inside tank, not below it
                    product.element.style.zIndex = '5';
                    
                    // Force reflow to ensure position is set before adding class
                    product.element.offsetHeight;
                    
                    // Add treatment class and restore animation only for treatment effects
                    product.element.classList.add('in-treatment');
                    product.element.style.transition = 'filter 0.5s ease-in-out, box-shadow 0.5s ease-in-out';
                    
                    console.log(`Product ${product.id} positioned at center of tank ${stationNumber}: ${tankPosition.x + centerOffset}px, ${tankPosition.y + 50}px - treatment started`);
                }
                
                product.station = stationNumber;
                
                console.log(`Product ${product.id} processing at station ${stationNumber}`);
                
                // Treatment time simulation
                setTimeout(() => {
                    console.log(`Product ${product.id} treatment finished at station ${stationNumber}`);
                    product.element.classList.remove('in-treatment');
                    
                    if (stationNumber === 20) {
                        // Product completed - move to finished position
                        product.element.style.transition = 'all 1s ease-in-out';
                        product.element.style.left = '2100px';
                        product.element.style.top = '250px'; // Same level as waiting products
                        product.element.style.zIndex = '1';
                        
                        console.log(`Product ${product.id} completed processing`);
                        
                        setTimeout(() => {
                            product.element.remove();
                            products.splice(products.indexOf(product), 1);
                            productionState.processedCount++;
                            productionState.productsInSystem--;
                            updateDisplay();
                        }, 2000);
                    } else {
                        // Move to waiting position for next station - level with tanks and centered
                        const currentTankPosition = tankPositions.find(pos => pos.station === stationNumber);
                        if (currentTankPosition) {
                            const tankWidth = 80; // Tank width in pixels
                            const productWidth = 60; // Actual product width from CSS
                            const centerOffset = (tankWidth - productWidth) / 2; // Offset to center product
                            
                            product.element.style.transition = 'all 1s ease-in-out';
                            product.element.style.left = (currentTankPosition.x + centerOffset) + 'px'; // Center above tank
                            product.element.style.top = '250px'; // Same level as initial products
                            product.element.style.zIndex = '1';
                            
                            console.log(`Product ${product.id} moved to waiting position above tank ${stationNumber}: ${currentTankPosition.x + centerOffset}px, 250px`);
                        }
                        
                        setTimeout(() => {
                            if (productionState.isRunning) {
                                console.log(`Product finished processing at station ${stationNumber}, ready for next crane operation`);
                                
                                // Don't automatically trigger next movement - let parallel system handle it
                                // The checkParallelCraneOperations function will pick this up
                                
                                // Special logging for handoff situations
                                if (stationNumber === 6) {
                                    console.log(`Product at station 6 ready for crane2 handoff`);
                                }
                            }
                        }, 2000);
                    }
                }, 3000);
            }
        }

        // Enhanced production cycle with parallel crane operations
        function beginProductionCycle() {
            if (!productionState.isRunning) return;
            
            // Check for parallel crane operations
            checkParallelCraneOperations();
            
            // Find products ready for initial processing
            const readyProduct = products.find(p => p.station === 0);
            const tank1Occupied = products.find(p => p.station === 1); // Check if tank 1 is occupied
            
            if (readyProduct && !transporter1.isMoving && !tank1Occupied) {
                readyProduct.station = 1;
                console.log(`Starting production cycle for product ${readyProduct.id} using crane1`);
                moveTransporterToStation(1);
            } else if (tank1Occupied) {
                console.log(`Tank 1 is occupied, waiting for it to be free before starting new product`);
            }
            
            // Schedule next cycle
            setTimeout(() => {
                if (productionState.isRunning && !demoMode) {
                    beginProductionCycle();
                }
            }, 8000); // Reduced time to check more frequently for parallel operations
        }

        // New function to find the highest priority product for a crane
        function findHighestPriorityProduct(craneId, operatingRange, searchStation = null) {
            let availableProducts = [];
            
            if (searchStation) {
                // Looking for products at a specific station
                availableProducts = products.filter(p => p.station === searchStation);
                console.log(`üîç Crane${craneId}: Found ${availableProducts.length} products at station ${searchStation}`);
            } else {
                // Looking for products ready to move within the crane's range
                // Filter products that are at stations where they can move to the next station in this crane's range
                for (let station of operatingRange) {
                    const productsAtPrevStation = products.filter(p => p.station === station - 1);
                    availableProducts = availableProducts.concat(productsAtPrevStation);
                }
                console.log(`üîç Crane${craneId}: Found ${availableProducts.length} products ready to move in range [${operatingRange.join(', ')}]`);
            }
            
            if (availableProducts.length === 0) {
                return null;
            }
            
            // Sort by station number (highest first) - products at higher tank numbers have priority
            // Then by product ID (higher/newer first) as a secondary priority
            availableProducts.sort((a, b) => {
                if (a.station !== b.station) {
                    return b.station - a.station; // Higher station number = higher priority
                }
                return b.id - a.id; // If same station, newer products have priority
            });
            
            const selectedProduct = availableProducts[0];
            console.log(`üéØ Crane${craneId}: Selected highest priority product ${selectedProduct.id} at station ${selectedProduct.station} from ${availableProducts.length} options`);
            
            // Log all available products for debugging
            if (availableProducts.length > 1) {
                console.log(`   Available products: ${availableProducts.map(p => `P${p.id}@S${p.station}`).join(', ')}`);
            }
            
            return selectedProduct;
        }

        // New function to enable parallel crane operations
        function checkParallelCraneOperations() {
            console.log(`\nüîÑ Checking parallel crane operations (${products.length} products in system)`);
            
            // Check crane1 range (stations 1-6) - prioritize highest tank numbers
            if (!transporter1.isMoving) {
                const highestPriorityProduct = findHighestPriorityProduct(1, [1, 2, 3, 4, 5, 6]);
                
                if (highestPriorityProduct) {
                    const targetStation = highestPriorityProduct.station + 1;
                    const tankOccupied = products.find(p => p.station === targetStation);
                    
                    if (!tankOccupied && targetStation <= 6) {
                        console.log(`üöõ Crane1 executing priority move: Product ${highestPriorityProduct.id} from station ${highestPriorityProduct.station} ‚Üí station ${targetStation}`);
                        setTimeout(() => moveTransporterToStation(targetStation), Math.random() * 1000);
                    } else if (tankOccupied) {
                        console.log(`‚è∏Ô∏è Crane1 waiting: Target station ${targetStation} occupied by product ${tankOccupied.id}`);
                    }
                }
            }
            
            // Check crane2 range (stations 6-10) - prioritize highest tank numbers
            if (!transporter2.isMoving) {
                const highestPriorityProduct = findHighestPriorityProduct(2, [6, 7, 8, 9, 10]);
                
                if (highestPriorityProduct) {
                    const targetStation = highestPriorityProduct.station + 1;
                    const tankOccupied = products.find(p => p.station === targetStation);
                    
                    if (!tankOccupied && targetStation >= 7 && targetStation <= 10) {
                        console.log(`üöõ Crane2 executing priority move: Product ${highestPriorityProduct.id} from station ${highestPriorityProduct.station} ‚Üí station ${targetStation}`);
                        setTimeout(() => moveTransporterToStation(targetStation), Math.random() * 1000);
                    } else if (tankOccupied) {
                        console.log(`‚è∏Ô∏è Crane2 waiting: Target station ${targetStation} occupied by product ${tankOccupied.id}`);
                    }
                }
            }
            
            // Check crane3 range (stations 10-15) - prioritize highest tank numbers
            if (!transporter3.isMoving) {
                const highestPriorityProduct = findHighestPriorityProduct(3, [10, 11, 12, 13, 14, 15]);
                
                if (highestPriorityProduct) {
                    const targetStation = highestPriorityProduct.station + 1;
                    const tankOccupied = products.find(p => p.station === targetStation);
                    
                    if (!tankOccupied && targetStation >= 11 && targetStation <= 15) {
                        console.log(`üöõ Crane3 executing priority move: Product ${highestPriorityProduct.id} from station ${highestPriorityProduct.station} ‚Üí station ${targetStation}`);
                        setTimeout(() => moveTransporterToStation(targetStation), Math.random() * 1000);
                    } else if (tankOccupied) {
                        console.log(`‚è∏Ô∏è Crane3 waiting: Target station ${targetStation} occupied by product ${tankOccupied.id}`);
                    }
                }
            }
            
            // Check crane4 range (stations 15-20) - prioritize highest tank numbers
            if (!transporter4.isMoving) {
                const highestPriorityProduct = findHighestPriorityProduct(4, [15, 16, 17, 18, 19, 20]);
                
                if (highestPriorityProduct) {
                    const targetStation = highestPriorityProduct.station + 1;
                    const tankOccupied = products.find(p => p.station === targetStation);
                    
                    if (!tankOccupied && targetStation >= 16 && targetStation <= 20) {
                        console.log(`üöõ Crane4 executing priority move: Product ${highestPriorityProduct.id} from station ${highestPriorityProduct.station} ‚Üí station ${targetStation}`);
                        setTimeout(() => moveTransporterToStation(targetStation), Math.random() * 1000);
                    } else if (tankOccupied) {
                        console.log(`‚è∏Ô∏è Crane4 waiting: Target station ${targetStation} occupied by product ${tankOccupied.id}`);
                    }
                }
            }
            
            // Special cases for handoffs - prioritize highest tank numbers at transition points
            // Handoff at station 6 ‚Üí 7 (check for products at station 6)
            const handoffProducts6to7 = products.filter(p => p.station === 6);
            if (handoffProducts6to7.length > 0 && !transporter2.isMoving) {
                // Sort by product ID or other priority metric if multiple products at station 6
                handoffProducts6to7.sort((a, b) => b.id - a.id); // Prioritize later created products
                const station7Occupied = products.find(p => p.station === 7);
                
                if (!station7Occupied) {
                    console.log(`Crane2 prioritizing handoff: Moving highest priority product from station 6 to station 7`);
                    setTimeout(() => moveTransporterToStation(7), Math.random() * 1000);
                }
            }
            
            // Handoff at station 10 ‚Üí 11 (check for products at station 10) 
            const handoffProducts10to11 = products.filter(p => p.station === 10);
            if (handoffProducts10to11.length > 0 && !transporter3.isMoving) {
                // Sort by product ID or other priority metric if multiple products at station 10
                handoffProducts10to11.sort((a, b) => b.id - a.id); // Prioritize later created products
                const station11Occupied = products.find(p => p.station === 11);
                
                if (!station11Occupied) {
                    console.log(`Crane3 prioritizing handoff: Moving highest priority product from station 10 to station 11`);
                    setTimeout(() => moveTransporterToStation(11), Math.random() * 1000);
                }
            }
            
            // Handoff at station 15 ‚Üí 16 (check for products at station 15)
            const handoffProducts15to16 = products.filter(p => p.station === 15);
            if (handoffProducts15to16.length > 0 && !transporter4.isMoving) {
                // Sort by product ID or other priority metric if multiple products at station 15
                handoffProducts15to16.sort((a, b) => b.id - a.id); // Prioritize later created products
                const station16Occupied = products.find(p => p.station === 16);
                
                if (!station16Occupied) {
                    console.log(`Crane4 prioritizing handoff: Moving highest priority product from station 15 to station 16`);
                    setTimeout(() => moveTransporterToStation(16), Math.random() * 1000);
                }
            }
        }

        // Start parallel crane monitoring
        function startParallelCraneMonitoring() {
            if (!productionState.isRunning) return;
            
            checkParallelCraneOperations();
            
            // Continue monitoring every 3 seconds
            setTimeout(() => {
                if (productionState.isRunning) {
                    startParallelCraneMonitoring();
                }
            }, 3000);
        }

        function skipToNext() {
            if (transporter1.position < 6) {
                moveTransporterToStation(transporter1.position + 1);
            } else {
                moveTransporterToStation(1);
            }
        }

        // Manual process start
        function startManualProcess() {
            if (!productionState.isRunning) {
                startProduction();
            }
            
            // Ensure there's a product to process
            if (products.length === 0) {
                loadNewProduct();
            }
            
            // Find the next product that needs processing
            const readyProduct = products.find(p => p.station === 0);
            if (readyProduct && !transporter.isMoving) {
                console.log('Manual process start - moving to station 1');
                moveTransporterToStation(1);
            } else {
                // If no product at station 0, check if we can continue with existing products
                const nextStation = transporter.position < 10 ? transporter.position + 1 : 1;
                const productAtCurrentStation = products.find(p => p.station === transporter.position);
                if (productAtCurrentStation && !transporter.isMoving) {
                    console.log(`Manual process continue - moving to station ${nextStation}`);
                    moveTransporterToStation(nextStation);
                }
            }
        }

        // Tank refill operation
        function refillTanks() {
            tankLevels.forEach(tank => {
                // Set target to optimal level (80% of max)
                tank.targetLevel = tank.minLevel + (tank.maxLevel - tank.minLevel) * 0.8;
            });
            
            updateStatus('tank-levels-status', 'REFILLING', 'warning');
            
            setTimeout(() => {
                updateStatus('tank-levels-status', 'NORMAL', 'ok');
            }, 5000);
        }

        // Monitor tank levels and update status
        function monitorTankLevels() {
            let lowTanks = 0;
            let highTanks = 0;
            
            tankLevels.forEach(tank => {
                if (tank.currentLevel < tank.minLevel + 0.1) lowTanks++;
                if (tank.currentLevel > tank.maxLevel - 0.1) highTanks++;
            });
            
            if (lowTanks > 2) {
                updateStatus('tank-levels-status', 'LOW LEVELS', 'error');
            } else if (highTanks > 2) {
                updateStatus('tank-levels-status', 'HIGH LEVELS', 'warning');
            } else if (lowTanks > 0 || highTanks > 0) {
                updateStatus('tank-levels-status', 'ATTENTION', 'warning');
            } else {
                updateStatus('tank-levels-status', 'NORMAL', 'ok');
            }
        }

        // Auto demo mode
        function autoDemo() {
            demoMode = true;
            startProduction();
            
            // Start by adding a product if none exist
            if (products.length === 0) {
                loadNewProduct();
            }
            
            // Begin the first movement
            setTimeout(() => {
                if (products.length > 0) {
                    console.log('Starting auto demo - moving to station 1');
                    moveTransporterToStation(1);
                }
            }, 2000);
            
            // Set up continuous demo cycle
            demoInterval = setInterval(() => {
                // Add new products periodically if we have fewer than 3
                if (products.length < 3) {
                    console.log('Adding new product for demo');
                    loadNewProduct();
                    
                    // Start processing the new product
                    setTimeout(() => {
                        const readyProduct = products.find(p => p.station === 0);
                        if (readyProduct && !transporter.isMoving) {
                            console.log('Moving new product to station 1');
                            moveTransporterToStation(1);
                        }
                    }, 1000);
                }
            }, 30000); // Add new product every 30 seconds
        }

        // Update display functions
        function updateDisplay() {
            document.getElementById('products-processed').textContent = productionState.processedCount;
            document.getElementById('cycle-time').textContent = productionState.cycleTime + ' min';
            document.getElementById('efficiency').textContent = productionState.efficiency + '%';
            document.getElementById('active-products').textContent = productionState.productsInSystem;
        }

        function updateStatus(elementId, value, statusClass = '') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
                element.className = 'status-value ' + statusClass;
            }
        }

        // Random variations for realism
        function startRandomVariations() {
            setInterval(() => {
                if (!demoMode) {
                    // Slight variations in metrics
                    productionState.cycleTime += (Math.random() - 0.5) * 0.2;
                    productionState.efficiency += (Math.random() - 0.5) * 0.5;
                    
                    // Keep within realistic bounds
                    productionState.cycleTime = Math.max(10, Math.min(15, productionState.cycleTime));
                    productionState.efficiency = Math.max(85, Math.min(99, productionState.efficiency));
                    
                    updateDisplay();
                    monitorTankLevels();
                }
            }, 3000);
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>